
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Autonomous Object Retrieval Robot</title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!-- <link href="../../assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet"> -->

    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <!-- <script src="../../assets/js/ie-emulation-modes-warning.js"></script> -->

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Autonomous Object Retrieval Robot</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#intro">Introduction</a></li>
            <li><a href="#obj">Project Objective</a></li>
            <li><a href="#design">Design</a></li>
            <li><a href="#drawings">Drawings</a></li>
            <li><a href="#testing">Testing</a></li>
            <li><a href="#result">Result</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">

      <div class="starter-template">
        <h1>Autonomous Object Retrieval Robot</h1>
        <p class="lead">ECE5725 2024Fall Project<br>A Project By Chenxin Xun and Pengru Lung.</p>
      </div>

      <hr>
      <div class="center-block">
          <iframe width="640" height="360" src="https://www.youtube.com/embed?v=et91Gea6CPk" frameborder="0" allowfullscreen></iframe>
          <h4 style="text-align:center;">Demonstration Video</h4>
      </div>

      <hr id="intro">

      <div style="text-align:center;">
              <h2>Introduction</h2>
              <p style="text-align: left;padding: 0px 30px;">This project aims to design and build an autonomous object retrieval robot capable of identifying and retrieving objects based on their color. The system utilizes a pair of Raspberry Pi devices, both equipped with cameras, and a robot with an arm featuring servos for object picking. The robot interacts with the user by receiving a color signal through a glove equipped with a camera, searching for the corresponding object, picking it up, and delivering it to the user.</p>
      </div>

    <hr id='obj'>

      <div class="row">
          <div class="col-md-4" style="text-align:center;">
          <img class="img-rounded" src="pics/robot2.jpg" alt="Generic placeholder image" width="377" height="240">
          </div>
          <div class="col-md-8" style="font-size:18px;">
          <h2>Project Objective:</h2>
          <ul>
            <li>Design an autonomous robot capable of identifying objects based on their color.</li>
            <li>Implement a robotic arm with servos for precise object picking and placement.</li>
            <li>Utilize two Raspberry Pi devices, both equipped with cameras, for message transmission and system control.</li>
            <li>Enable user interaction via a camera-equipped glove to specify the desired object color.</li>
            <li>Ensure smooth and reliable object detection, retrieval, and delivery to the user.</li>
          </ul>
          </div>
      </div>

    <hr id='design'>

      <div style="text-align:center;">
              <h2>Design</h2>
              <h3 style="text-align: center; padding: 0px 150px;">Hardware Design</h3>
              <h4 style="text-align: center; padding: 0px 150px;">Glove Design</h4>
              <p style="text-align: justify; padding: 0px 150px;">We have mounted the Raspberry Pi 4 and a camera onto the glove. Also, we implemented a button on the Raspberry Pi 4 to control the camera. Using soldering, we connected the button and a 1kΩ resistor, wiring them to GPIO pin 17 and Ground. This setup was thoroughly tested to ensure both the hardware’s stability and the responsiveness of the button control.</p>
              <h4 style="text-align: center; padding: 0px 150px;">Robot Design</h4>
              <p style="text-align: justify; padding: 0px 150px;">In our robot design, we utilize a Raspberry Pi 4 to control the robot's movements and arm. The robot is equipped with two servos for controlling the arm and two servos for robot movement. The servos are connected to specific GPIO pins on the Raspberry Pi, which are used to send control signals for precise movement. The Raspberry Pi acts as the central control unit, coordinating the servos' actions based on the input from the camera-equipped glove. Our GPIO pin mappings are shown in the table below.</p> 
              <h4 style="text-align: center; padding: 0px 150px;">Table 1: RaspberryPi GPIO Pin to Signal Mapping</h4>
              <table style="width: 100%; text-align: center; padding: 0px 150px; border-collapse: collapse;">
                <tr>
                  <th style="border-bottom: 1px solid #D3D3D3; padding: 8px; text-align: center;">Pi GPIO Pin</th>
                  <th style="border-bottom: 1px solid #D3D3D3; padding: 8px; text-align: center;">Signal Name</th>
                  <tr>
                    <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 4</td>
                    <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Robot wrist rotation control</td>
                  </tr>
                  <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 5</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Direction control for left motor</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 6</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Direction control for left motor</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 12</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Robot arm base rotation control</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 13</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Robot shoulder elevation control</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 16</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">PWM signal for right motor</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 19</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">PWM signal for left motor</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 20</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Direction control for right motor</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 21</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Direction control for right motor</td>
                  <tr>
                    <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 26</td>
                    <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Robot elbow joint control</td>
              </table>   
              <h3 style="text-align: center; padding: 0px 150px;">Software Design</h3>
              <h4 style="text-align: center; padding: 0px 150px;">Glove Design</h4>
              <p style="text-align: justify; padding: 0px 150px;">The software design for the device is centered around detecting and identifying color-coded objects using computer vision techniques and sending the detected color to the robot. The program utilizes the OpenCV library (cv2) for real-time image processing, where the camera feed is continuously captured and analyzed to detect specific color cubes.</p>
              <p style="text-align: justify; padding: 0px 150px;">1. The Color Detection: The color detection is based on the HSV color space, with predefined ranges for different colors (Green, Blue, Yellow). The software first captures a frame from the camera, converts it to the HSV color space, and then applies a mask to isolate regions of the image matching the color ranges. Contours of these regions are found and used to calculate the center of the object.</p>
              <p style="text-align: justify; padding: 0px 150px;">2. System Integration: A button is used to trigger the color detection process, allowing the user to initiate the system when desired. The system utilizes Wi-Fi communication to transmit the detected color information. Once the color is detected, the software sends the color information via a socket connection over Wi-Fi to a remote server. This ensures the robot is informed of the object’s color for further action in real-time.</p>
              <h4 style="text-align: center; padding: 0px 150px;">Robot Design</h4>
              <p style="text-align: justify; padding: 0px 150px;">1. Server: The robot's communication system uses Wi-Fi for seamless data exchange with the camera-equipped glove. The robot acts as a server, listening for connections on a specific IP and port, while the glove connects as a client. Upon receiving signals from the glove, the server decodes the data and triggers actions based on the detected color. This setup ensures real-time, efficient coordination between the glove and the robot. </p> 
              <p style="text-align: justify; padding: 0px 150px;">2. Arm control</p>
              <p style="text-align: justify; padding: 0px 150px;">3. Motor control</p>
              <p style="text-align: justify; padding: 0px 150px;">2. Integration</p>

      </div>

    <hr id='drawings'>

      <div style="text-align:center;">
              <h2>Drawings</h2>
              <p style="text-align: left;padding: 0px 30px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vestibulum lorem nulla, consectetur at leo vel, pretium bibendum nisl. Cras blandit quam a enim ultrices, eu convallis enim posuere. Donec eleifend enim sed purus consectetur, vitae cursus lectus varius. Vivamus consectetur felis nec est venenatis posuere. Phasellus vitae aliquet erat. In laoreet lacinia mollis. Quisque iaculis nisl fermentum pharetra lobortis. Donec rhoncus dui sem, ac molestie leo tristique vel. Phasellus in nibh feugiat, fringilla lectus in, elementum magna. Etiam quis dui condimentum, tempus ex in, dapibus est. Cras ut congue augue. Donec ac enim ex. Ut id tristique risus, vel porttitor quam. Sed ultricies enim eu nibh porttitor, vel sodales enim feugiat. Fusce volutpat venenatis magna ac ultrices. Curabitur eget urna ut nulla mattis convallis non eu diam.</p>
      </div>

    <hr id='testing'>

      <div style="text-align:center;">
              <h2>Testing</h2>
              <p style="text-align: left;padding: 0px 30px;">In our testing, we conducted separate tests for the glove and the robot. We tested the glove by pointing it at a specific color and printing the color. For the robot, we tested it by placing a ball in front of it, and the robot was able to pick up the ball. With the basic tests passed, we also implemented additional tests, such as ensuring the robot can ignore balls of different colors and pick up only the assigned color. Additionally, we tested its ability to detect the blue bar and return it to the designated location.</p>
              <p style="text-align: left;padding: 0px 30px;">After thoroughly testing these two devices, we performed system integration. In this test, the glove points to a color, and the glove sends the color to the robot. The robot should follow the color contained in the message, go pick up the ball, and return it to its designated location.</p>
              <p style="text-align: left;padding: 0px 30px;">In our testing, sometimes the robot can pick up the ball correctly, but there are instances where it does not work as expected. In some cases, we need to perform calibration. Additionally, due to some multithreading issues, the camera did not close correctly, causing the video to reopen unexpectedly. In general, we need to recalibrate the robot after approximately 10 pickups. Also, when the robot continuously picks up and returns balls without restarting the program, the camera may encounter issues opening properly. However, once the calibration is complete and the program is restarted, the robot can perform the task of picking up different balls in most situations.</p>
      </div>

    <hr id='result'>

      <div style="text-align:center;">
              <h2>Result</h2>
              <p style="text-align: left;padding: 0px 30px;">In conclusion, we have the glove point to a specific color and use Wi-Fi transmission to send the assigned color to the robot. The robot can detect the specific color ball, move towards it, pick it up, and return the ball to the designated position. We have our demonstration in the video above. In this project, we still need to improve reliability, whether by using more decision-making processes to determine whether the ball has been picked up, performing calibration automatically, adding PID control to regulate the signal, or improving multithreading for more stable performance.</p>
              <p style="text-align: left;padding: 0px 30px;">All in all, we consider this five-week project to be a significant achievement and a great learning experience.</p>
    <hr>
    <hr id='work'>
    <div class="row" style="text-align:center;">
          <h2>Work Distribution</h2>
          <div style="text-align:center;">

          </div>
          <div class="col-md-6" style="font-size:16px">
              <img class="img-rounded" src="pics/a.png" alt="Generic placeholder image" width="240" height="240">
              <h3>Chenxin Xun</h3>
              <p class="lead">cx258@cornell.edu</p>
              <p>Robot Movement and Object Retrieval Design
          </div>
          <div class="col-md-6" style="font-size:16px">
              <img class="img-rounded" src="pics/b.png" alt="Generic placeholder image" width="240" height="240">
              <h3>Peng-Ru Lung</h3>
              <p class="lead">pl649@cornell.edu</p>
              <p>Design of Camera-Equipped Glove and Transmission System 
          </div>
      </div>
      <hr>
      <div style="font-size:18px; text-align: left;">
          <h2>Parts List</h2>            
          <ul>
              <li>Raspberry Pi 4 $35.00</li>
              <li>Raspberry Pi Camera V2 $20.00</li>
              <li>Raspberry Pi Camera V2 $20.00</li>
              <a href="https://www.amazon.com/dp/B081YH77C3?ref=ppx%20yo2ov%20dt%20b%20fed%20asin%20title"><li>Robot Arm - $22.13</li></a>
              <li>Resistors, Wires and Buttons- Provided in lab</li>
          </ul>
          <h3>Total: $97.13</h3>
        </div>
        <hr>
        <div style="font-size:18px; text-align: left;">
            <h2>References</h2>
            <a style="font-size: 18px; text-align: left;">
          <a href="https://picamera.readthedocs.io/">PiCamera Document</a><br>
          <a href="http://www.micropik.com/PDF/SG90Servo.pdf">Tower Pro Servo Datasheet</a><br>
          <a href="http://abyz.co.uk/rpi/pigpio/">Pigpio Library</a><br>
          <a href="https://sourceforge.net/p/raspberry-gpio-python/wiki/Home/">R-Pi GPIO Document</a><br>
          <a href="https://projects.raspberrypi.org/en/projects/get-started-pico-w/3">Open a Socket</a><br>

      </div>

      <hr>

      <div style="font-size:18px; text-align: left;">
              <h2>Code Appendix</h2>
                          
<h3>color_detect.py</h3>
<pre><code>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">cv2</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">threading</span>
<span style="color: #888888"># from server_color import data</span>

stop <span style="color: #333333">=</span> <span style="color: #007020">False</span>
cap <span style="color: #333333">=</span> <span style="color: #007020">None</span> <span style="color: #888888"># Video capture object</span>
lock <span style="color: #333333">=</span> threading<span style="color: #333333">.</span>Lock()
color_name <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;&#39;</span> <span style="color: #888888"># Detected color name</span>
cx <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span> 
cy <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
approx <span style="color: #333333">=</span> [] <span style="color: #888888"># Approximated contour points for the detected cube</span>
target <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;Blue&#39;</span>
target_pos <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">305</span> <span style="color: #888888"># Y-coordinate threshold to trigger a stop</span>
step_stop <span style="color: #333333">=</span> <span style="color: #007020">False</span>

<span style="color: #888888"># New variables for threshold filtering</span>
enable_threshold_filter <span style="color: #333333">=</span> <span style="color: #007020">False</span>
min_y_threshold <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">130</span>

<span style="color: #888888"># Define HSV color ranges for seven different colors</span>
color_ranges <span style="color: #333333">=</span> {
    <span style="background-color: #fff0f0">&quot;Green&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">36</span>, <span style="color: #0000DD; font-weight: bold">25</span>, <span style="color: #0000DD; font-weight: bold">25</span>], [<span style="color: #0000DD; font-weight: bold">86</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),
    <span style="background-color: #fff0f0">&quot;Blue&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">94</span>, <span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">2</span>], [<span style="color: #0000DD; font-weight: bold">126</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),
    <span style="background-color: #fff0f0">&quot;Yellow&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">20</span>, <span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">80</span>], [<span style="color: #0000DD; font-weight: bold">30</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),
    <span style="background-color: #fff0f0">&quot;Orange&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">3</span>, <span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">100</span>], [<span style="color: #0000DD; font-weight: bold">12</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),
    <span style="background-color: #fff0f0">&quot;Purple&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">130</span>, <span style="color: #0000DD; font-weight: bold">50</span>, <span style="color: #0000DD; font-weight: bold">50</span>], [<span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),
    <span style="background-color: #fff0f0">&quot;Cyan&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">85</span>, <span style="color: #0000DD; font-weight: bold">100</span>, <span style="color: #0000DD; font-weight: bold">100</span>], [<span style="color: #0000DD; font-weight: bold">95</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>])
}

<span style="color: #888888"># Function to find and identify color cubes in a frame</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">find_color_cubes</span>(frame):
    <span style="color: #888888"># Convert the frame to HSV color space</span>
    hsv_frame <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(frame, cv2<span style="color: #333333">.</span>COLOR_BGR2HSV)
    <span style="color: #888888"># Loop through each defined color range</span>
    <span style="color: #008800; font-weight: bold">for</span> c_name, (lower, upper) <span style="color: #000000; font-weight: bold">in</span> color_ranges<span style="color: #333333">.</span>items():
        lower_bound <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array(lower, dtype<span style="color: #333333">=</span>np<span style="color: #333333">.</span>uint8)
        upper_bound <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array(upper, dtype<span style="color: #333333">=</span>np<span style="color: #333333">.</span>uint8)

        <span style="color: #888888"># Create a binary mask where color is detected</span>
        mask <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>inRange(hsv_frame, lower_bound, upper_bound)
        mask <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>erode(mask, <span style="color: #007020">None</span>, iterations<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #888888"># Remove noise</span>
        mask <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>dilate(mask, <span style="color: #007020">None</span>, iterations<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #888888"># Enhance detected regions</span>

        <span style="color: #888888"># Find contours in the mask</span>
        contours, _ <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>findContours(mask, cv2<span style="color: #333333">.</span>RETR_EXTERNAL, cv2<span style="color: #333333">.</span>CHAIN_APPROX_SIMPLE)

        <span style="color: #008800; font-weight: bold">for</span> contour <span style="color: #000000; font-weight: bold">in</span> contours:
            area <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>contourArea(contour)
            <span style="color: #008800; font-weight: bold">if</span> area <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">300</span>:  <span style="color: #888888"># Adjust area threshold as needed</span>
                <span style="color: #888888"># Approximate the contour&#39;s shape</span>
                epsilon <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.02</span> <span style="color: #333333">*</span> cv2<span style="color: #333333">.</span>arcLength(contour, <span style="color: #007020">True</span>)
                approx_pts <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>approxPolyDP(contour, epsilon, <span style="color: #007020">True</span>)

                <span style="color: #888888"># Calculate the center of the contour</span>
                M <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>moments(contour)
                <span style="color: #008800; font-weight: bold">if</span> M[<span style="background-color: #fff0f0">&quot;m00&quot;</span>] <span style="color: #333333">!=</span> <span style="color: #0000DD; font-weight: bold">0</span>:
                    cx_local <span style="color: #333333">=</span> <span style="color: #007020">int</span>(M[<span style="background-color: #fff0f0">&quot;m10&quot;</span>] <span style="color: #333333">/</span> M[<span style="background-color: #fff0f0">&quot;m00&quot;</span>])
                    cy_local <span style="color: #333333">=</span> <span style="color: #007020">int</span>(M[<span style="background-color: #fff0f0">&quot;m01&quot;</span>] <span style="color: #333333">/</span> M[<span style="background-color: #fff0f0">&quot;m00&quot;</span>])
                <span style="color: #008800; font-weight: bold">else</span>:
                    cx_local, cy_local <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>

                <span style="color: #888888"># Apply the threshold filter if enabled</span>
                <span style="color: #008800; font-weight: bold">if</span> enable_threshold_filter <span style="color: #000000; font-weight: bold">and</span> cy_local <span style="color: #333333">&lt;</span> min_y_threshold:
                    <span style="color: #888888"># Skip this contour since it&#39;s below the minimum y-threshold</span>
                    <span style="color: #008800; font-weight: bold">continue</span>

                <span style="color: #888888"># If the centroid is within the frame, print RGB values</span>
                <span style="color: #008800; font-weight: bold">if</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #333333">&lt;=</span> cx_local <span style="color: #333333">&lt;</span> frame<span style="color: #333333">.</span>shape[<span style="color: #0000DD; font-weight: bold">1</span>] <span style="color: #000000; font-weight: bold">and</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #333333">&lt;=</span> cy_local <span style="color: #333333">&lt;</span> frame<span style="color: #333333">.</span>shape[<span style="color: #0000DD; font-weight: bold">0</span>]:
                    rgb_values <span style="color: #333333">=</span> frame[cy_local, cx_local]
                    <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;RGB values at ({cx_local}, {cy_local}): {rgb_values}&quot;</span>)

                <span style="color: #888888"># Draw the contour and label on the frame</span>
                cv2<span style="color: #333333">.</span>drawContours(frame, [approx_pts], <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>, (<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">0</span>), <span style="color: #0000DD; font-weight: bold">2</span>)
                cv2<span style="color: #333333">.</span>putText(frame, f<span style="background-color: #fff0f0">&quot;{c_name} Cube&quot;</span>, (cx_local, cy_local <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">10</span>), cv2<span style="color: #333333">.</span>FONT_HERSHEY_SIMPLEX, <span style="color: #6600EE; font-weight: bold">0.5</span>, (<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">0</span>), <span style="color: #0000DD; font-weight: bold">2</span>)
                cv2<span style="color: #333333">.</span>circle(frame, (cx_local, cy_local), <span style="color: #0000DD; font-weight: bold">5</span>, (<span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>), <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>)
                <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;Detected {c_name} cube at position: ({cx_local}, {cy_local})&quot;</span>)

                <span style="color: #008800; font-weight: bold">return</span> c_name, cx_local, cy_local, approx_pts <span style="color: #888888"># Return detected cube info</span>

    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, []  <span style="color: #888888"># Return default values if no color cube found</span>

<span style="color: #888888"># Function for real-time color detection</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">color_detection</span>():
    <span style="color: #008800; font-weight: bold">global</span> stop, cap, color_name, cx, cy, approx
    cap <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>VideoCapture(<span style="color: #0000DD; font-weight: bold">0</span>)  <span style="color: #888888"># Open the default camera</span>

    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
        <span style="color: #888888"># print(&quot;Target::::::::::::::::::&quot;, target)</span>
        ret, frame <span style="color: #333333">=</span> cap<span style="color: #333333">.</span>read()
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> ret:  <span style="color: #888888"># If frame capture fails, stop the program</span>
            cd_stop()
            <span style="color: #008800; font-weight: bold">break</span>
        <span style="color: #888888"># Detect color cubes in the current frame</span>
        color_name1, cx1, cy1, approx1 <span style="color: #333333">=</span> find_color_cubes(frame)
        <span style="color: #888888"># Process the frame to find color cubes</span>
        <span style="color: #008800; font-weight: bold">with</span> lock:
            color_name <span style="color: #333333">=</span> color_name1
            cx <span style="color: #333333">=</span> cx1
            cy <span style="color: #333333">=</span> cy1
            approx <span style="color: #333333">=</span> approx1
            <span style="color: #888888"># Stop if &#39;q&#39; is pressed or the target conditions are met</span>
            <span style="color: #008800; font-weight: bold">if</span> cv2<span style="color: #333333">.</span>waitKey(<span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xFF</span> <span style="color: #333333">==</span> <span style="color: #007020">ord</span>(<span style="background-color: #fff0f0">&#39;q&#39;</span>):
                stop <span style="color: #333333">=</span> <span style="color: #007020">True</span>
                cd_stop()
                <span style="color: #008800; font-weight: bold">break</span>

            <span style="color: #008800; font-weight: bold">if</span> cy <span style="color: #333333">&gt;</span> target_pos <span style="color: #000000; font-weight: bold">and</span> target <span style="color: #333333">==</span> color_name:
                stop <span style="color: #333333">=</span> <span style="color: #007020">True</span>
                cd_stop()
                <span style="color: #008800; font-weight: bold">break</span>

            <span style="color: #008800; font-weight: bold">if</span> cy <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">260</span> <span style="color: #000000; font-weight: bold">and</span> target <span style="color: #333333">==</span> color_name:
                step_stop <span style="color: #333333">=</span> <span style="color: #007020">True</span>
                
<span style="color: #888888"># Function to release resources and close windows</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">cd_stop</span>():
    <span style="color: #008800; font-weight: bold">global</span> cap
    cap<span style="color: #333333">.</span>release()  <span style="color: #888888"># Release the video capture object</span>
    cv2<span style="color: #333333">.</span>destroyAllWindows() <span style="color: #888888"># Close all OpenCV windows</span>
              </code></pre>
<h3>Server_color.py</h3>
<pre><code>
<span style="color: #0e84b5; font-weight: bold">import socket</span>
<span style="color: #888888"># Function to handle receiving color data from a client</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">sending_color</span>():
  <span style="color: #008800; font-weight: bold">global</span> data
  <span style="color: #888888"># Server configuration</span>
  HOST <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;10.49.240.92&#39;</span> <span style="color: #888888"># Server&#39;s IP address</span>
  PORT <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5000</span>      <span style="color: #888888"># Port to listen on</span>

  <span style="color: #888888"># Create a socket</span>
  server_socket <span style="color: #333333">=</span> socket<span style="color: #333333">.</span>socket(socket<span style="color: #333333">.</span>AF_INET, socket<span style="color: #333333">.</span>SOCK_STREAM)
  <span style="color: #888888"># Allow address reuse</span>
  server_socket<span style="color: #333333">.</span>setsockopt(socket<span style="color: #333333">.</span>SOL_SOCKET, socket<span style="color: #333333">.</span>SO_REUSEADDR, <span style="color: #0000DD; font-weight: bold">1</span>)  
  <span style="color: #888888"># Bind the socket to the specified IP and port</span>
  server_socket<span style="color: #333333">.</span>bind((HOST, PORT)) 
  <span style="color: #888888"># Listen for incoming connections (1 client at a time)</span>
  server_socket<span style="color: #333333">.</span>listen(<span style="color: #0000DD; font-weight: bold">1</span>) 

  <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Server is waiting for a connection...&quot;</span>)

  <span style="color: #888888"># Accept a connection</span>
  client_socket, client_address <span style="color: #333333">=</span> server_socket<span style="color: #333333">.</span>accept()
  <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;Connected by {client_address}&quot;</span>)

  <span style="color: #888888"># Receive data</span>
  data <span style="color: #333333">=</span> client_socket<span style="color: #333333">.</span>recv(<span style="color: #0000DD; font-weight: bold">1024</span>)<span style="color: #333333">.</span>decode(<span style="background-color: #fff0f0">&#39;utf-8&#39;</span>)
  <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;Received: {data}&quot;</span>)

  <span style="color: #888888"># Close the client and server sockets to clean up resources</span>
  client_socket<span style="color: #333333">.</span>close()
  server_socket<span style="color: #333333">.</span>close()
          </code></pre>         
  <h3>color_detect_send.py</h3>
  <pre><code>
  <span style="color: #008800; font-weight: bold">import</span><span style="color: #0e84b5; font-weight: bold">socket</span> <span style="color: #888888"># For video capture and image processing</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">threading</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">socket</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">RPi._GPIO</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">GPIO</span> <span style="color: #888888"># For Raspberry Pi GPIO control</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>
  <span style="color: #888888"># Configure GPIO settings</span>
  GPIO<span style="color: #333333">.</span>setmode(GPIO<span style="color: #333333">.</span>BCM)
  GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">17</span>, GPIO<span style="color: #333333">.</span>IN, pull_up_down<span style="color: #333333">=</span>GPIO<span style="color: #333333">.</span>PUD_UP)
  
  stop <span style="color: #333333">=</span> <span style="color: #007020">False</span> 
  cap <span style="color: #333333">=</span> <span style="color: #007020">None</span>
  lock <span style="color: #333333">=</span> threading<span style="color: #333333">.</span>Lock()
  color_name <span style="color: #333333">=</span> &#39;&#39;</span>
  
  <span style="color: #888888"># Server connection IP address and port number</span>
  HOST <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;10.49.240.92&#39;</span>
  PORT <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5000</span>        
  
  <span style="color: #888888"># Define HSV color ranges for different colors</span>
  color_ranges <span style="color: #333333">=</span> {
    <span style="background-color: #fff0f0">&quot;Green&quot; </span>: ([<span style="color: #0000DD; font-weight: bold">45</span>, <span style="color: #0000DD; font-weight: bold">35</span>, <span style="color: #0000DD; font-weight: bold">35</span>], [<span style="color: #0000DD; font-weight: bold">75</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),    
    <span style="background-color: #fff0f0">&quot;Blue&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">105</span>, <span style="color: #0000DD; font-weight: bold">125</span>, <span style="color: #0000DD; font-weight: bold">125</span>], [<span style="color: #0000DD; font-weight: bold">135</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),  
    <span style="background-color: #fff0f0">&quot;Yellow&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">20</span>, <span style="color: #0000DD; font-weight: bold">180</span>, <span style="color: #0000DD; font-weight: bold">180</span>], [<span style="color: #0000DD; font-weight: bold">40</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]), 
  }
  
  <span style="color: #888888"># Function to identify the main color in a frame</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">find_main_color</span>(frame):
      <span style="color: #888888"># Convert the frame to HSV color space</span>
      hsv_frame <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(frame, cv2<span style="color: #333333">.</span>COLOR_BGR2HSV)
  
      <span style="color: #888888"># Initialize to store color count</span>
      color_count <span style="color: #333333">=</span> {color: <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #008800; font-weight: bold">for</span> color <span style="color: #000000; font-weight: bold">in</span> color_ranges}
      <span style="color: #888888"># Loop through each color range and apply a mask</span>
      <span style="color: #008800; font-weight: bold">for</span> color_name, (lower, upper) <span style="color: #000000; font-weight: bold">in</span> color_ranges<span style="color: #333333">.</span>items():
          <span style="color: #888888"># Create lower and upper bound arrays</span>
          lower_bound <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array(lower, dtype<span style="color: #333333">=</span>np<span style="color: #333333">.</span>uint8)
          upper_bound <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array(upper, dtype<span style="color: #333333">=</span>np<span style="color: #333333">.</span>uint8)
  
          <span style="color: #888888"># Create a binary mask where color is detected</span>
          mask <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>inRange(hsv_frame, lower_bound, upper_bound)
  
          <span style="color: #888888"># Count the number of pixels matching the color</span>
          color_count[color_name] <span style="color: #333333">=</span> np<span style="color: #333333">.</span>sum(mask)  <span style="color: #888888"># Sum the pixels that match the color</span>
  
      <span style="color: #888888"># Determine the main color (the one with the highest count)</span>
      main_color <span style="color: #333333">=</span> <span style="color: #007020">max</span>(color_count, key<span style="color: #333333">=</span>color_count<span style="color: #333333">.</span>get)
      <span style="color: #888888"># Ignore insignificant detections</span>
      <span style="color: #008800; font-weight: bold">if</span> color_count[main_color] <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">300</span>:
          <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>
      <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;The main color detected is: {main_color}&quot;</span>)
      <span style="color: #008800; font-weight: bold">return</span> main_color
  
  <span style="color: #888888"># Function to send the detected color to a server</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">send_color</span>(message):
      <span style="color: #888888"># Create a client socket </span>
      client_socket <span style="color: #333333">=</span> socket<span style="color: #333333">.</span>socket(socket<span style="color: #333333">.</span>AF_INET, socket<span style="color: #333333">.</span>SOCK_STREAM)
      <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
          <span style="color: #008800; font-weight: bold">try</span>:
              <span style="color: #888888"># Try to connect to the server</span>
              client_socket<span style="color: #333333">.</span>connect((HOST, PORT))
              <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Connected to the server successfully.&quot;</span>)
              <span style="color: #008800; font-weight: bold">break</span>  <span style="color: #888888"># Exit the loop once connected</span>
          <span style="color: #008800; font-weight: bold">except</span> socket<span style="color: #333333">.</span>error <span style="color: #008800; font-weight: bold">as</span> e:
              <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;Connection failed: {e}. Retrying in 5 seconds...&quot;</span>)
              time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">5</span>)  <span style="color: #888888"># Wait for 5 seconds before retrying</span>
  
      <span style="color: #888888"># Send the encoded message to the server</span>
      client_socket<span style="color: #333333">.</span>send(message<span style="color: #333333">.</span>encode(<span style="background-color: #fff0f0">&#39;utf-8&#39;</span>))
      time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">3</span>) 
  
      <span style="color: #888888"># Close the connection</span>
      client_socket<span style="color: #333333">.</span>close()
      <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Connection closed.&quot;</span>)
  
  <span style="color: #888888"># Function to handle color detection    </span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">color_detection</span>():
      <span style="color: #008800; font-weight: bold">global</span> stop, cap, color_name
      cap <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>VideoCapture(<span style="color: #0000DD; font-weight: bold">0</span>)  <span style="color: #888888"># Open the default camera</span>
      
      <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
          ret, frame <span style="color: #333333">=</span> cap<span style="color: #333333">.</span>read() <span style="color: #888888"># Capture a frame</span>
          <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> ret:
              cd_stop() <span style="color: #888888"># Stop if no frame is captured</span>
              <span style="color: #008800; font-weight: bold">break</span>
  
          <span style="color: #888888"># Process the frame to find color cubes</span>
          <span style="color: #008800; font-weight: bold">with</span> lock:
              color_name <span style="color: #333333">=</span> find_main_color(frame) <span style="color: #888888"># Detect main color</span>
          <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;color_detection:::::::::::::::::::&quot;</span>, color_name)  
          time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.5</span>)  
          <span style="color: #888888"># If a recognized color is detected, send it to the server</span>
          <span style="color: #008800; font-weight: bold">if</span> (color_name<span style="color: #333333">==</span><span style="background-color: #fff0f0">&quot;Green&quot;</span> <span style="color: #000000; font-weight: bold">or</span> color_name<span style="color: #333333">==</span><span style="background-color: #fff0f0">&quot;Yellow&quot;</span> <span style="color: #000000; font-weight: bold">or</span> color_name<span style="color: #333333">==</span><span style="background-color: #fff0f0">&quot;Blue&quot;</span>):
              message <span style="color: #333333">=</span> f<span style="background-color: #fff0f0">&quot;{color_name}&quot;</span>
              cd_stop()
              send_color(message)
  
          <span style="color: #888888"># Exit the loop if &#39;q&#39; is pressed</span>
          <span style="color: #008800; font-weight: bold">if</span> cv2<span style="color: #333333">.</span>waitKey(<span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xFF</span> <span style="color: #333333">==</span> <span style="color: #007020">ord</span>(<span style="background-color: #fff0f0">&#39;q&#39;</span>):
              stop <span style="color: #333333">=</span> <span style="color: #007020">True</span>
              cd_stop()
              <span style="color: #008800; font-weight: bold">break</span>
  <span style="color: #888888"># Function to clean up video capture resources</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">cd_stop</span>():
      <span style="color: #008800; font-weight: bold">global</span> cap
      cap<span style="color: #333333">.</span>release() <span style="color: #888888"># Release the camera</span>
      cv2<span style="color: #333333">.</span>destroyAllWindows() <span style="color: #888888"># Close all OpenCV windows</span>
  
  <span style="color: #008800; font-weight: bold">try</span>:
      <span style="color: #008800; font-weight: bold">while</span>(<span style="color: #007020">True</span>):
          flag17 <span style="color: #333333">=</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">17</span>) <span style="color: #888888"># Monitor GPIO pin 17 for input</span>
          <span style="color: #008800; font-weight: bold">while</span>(flag17): 
              time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.1</span>)  
              flag17 <span style="color: #333333">=</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">17</span>)
              <span style="color: #008800; font-weight: bold">if</span> flag17<span style="color: #333333">==</span><span style="color: #0000DD; font-weight: bold">0</span>: <span style="color: #888888"># Start color detection when flag17 is low</span>
                  color_detection()
  <span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">KeyboardInterrupt</span>:
      <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Keyboard interrupt received. Cleaning up...&quot;</span>)
  <span style="color: #008800; font-weight: bold">finally</span>:
      GPIO<span style="color: #333333">.</span>cleanup() <span style="color: #888888"># Reset GPIO pins</span>
      cd_stop()  <span style="color: #888888"># Release camera and clean up resources</span>
                </code></pre>
<h3>arm_control.py</h3>
                    <pre><code>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">pigpio</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>
<span style="color: #888888"># Initialize pigpio and check connection</span>
pi <span style="color: #333333">=</span> pigpio<span style="color: #333333">.</span>pi()
<span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> pi<span style="color: #333333">.</span>connected:
    <span style="color: #007020">exit</span>(<span style="background-color: #fff0f0">&quot;Failed to connect to pigpio daemon&quot;</span>) <span style="color: #888888"># Exit if unable to connect</span>
<span style="color: #888888"># Define the minimum duty cycles for each servo motor</span>
min_duties <span style="color: #333333">=</span> [<span style="color: #6600EE; font-weight: bold">4.3</span>, <span style="color: #6600EE; font-weight: bold">5.8</span>, <span style="color: #0000DD; font-weight: bold">4</span>, <span style="color: #0000DD; font-weight: bold">5</span>]
<span style="color: #888888"># Define specifications for each servo motor (pin numbers and pulse width ranges)</span>
servo_specs <span style="color: #333333">=</span> {
    <span style="background-color: #fff0f0">&#39;base&#39;</span>: {
        <span style="background-color: #fff0f0">&#39;pin&#39;</span>: <span style="color: #0000DD; font-weight: bold">12</span>,
        <span style="background-color: #fff0f0">&#39;min_pw&#39;</span>: min_duties[<span style="color: #0000DD; font-weight: bold">0</span>]<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>,              <span style="color: #888888"># e.g. 4 * 200 = 800µs</span>
        <span style="background-color: #fff0f0">&#39;max_pw&#39;</span>: (min_duties[<span style="color: #0000DD; font-weight: bold">0</span>]<span style="color: #333333">+</span><span style="color: #6600EE; font-weight: bold">8.5</span>)<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>         <span style="color: #888888"># e.g. (4+8.5)*200 = 2500µs</span>
    },
    <span style="background-color: #fff0f0">&#39;shoulder&#39;</span>: {
        <span style="background-color: #fff0f0">&#39;pin&#39;</span>: <span style="color: #0000DD; font-weight: bold">13</span>,
        <span style="background-color: #fff0f0">&#39;min_pw&#39;</span>: min_duties[<span style="color: #0000DD; font-weight: bold">1</span>]<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>,              <span style="color: #888888"># 5.5 * 200 = 1100µs</span>
        <span style="background-color: #fff0f0">&#39;max_pw&#39;</span>: (min_duties[<span style="color: #0000DD; font-weight: bold">1</span>]<span style="color: #333333">+</span><span style="color: #6600EE; font-weight: bold">5.6</span>)<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>         <span style="color: #888888"># (5.5+5.6)*200 = 2220µs</span>
    },
    <span style="background-color: #fff0f0">&#39;elbow&#39;</span>: {
        <span style="background-color: #fff0f0">&#39;pin&#39;</span>: <span style="color: #0000DD; font-weight: bold">26</span>,
        <span style="background-color: #fff0f0">&#39;min_pw&#39;</span>: min_duties[<span style="color: #0000DD; font-weight: bold">2</span>]<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>,              <span style="color: #888888"># 4 * 200 = 800µs</span>
        <span style="background-color: #fff0f0">&#39;max_pw&#39;</span>: (min_duties[<span style="color: #0000DD; font-weight: bold">2</span>]<span style="color: #333333">+</span><span style="color: #6600EE; font-weight: bold">3.4</span>)<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>         <span style="color: #888888"># (4+3.4)*200 = 1480µs</span>
    },
    <span style="background-color: #fff0f0">&#39;wrist&#39;</span>: {
        <span style="background-color: #fff0f0">&#39;pin&#39;</span>: <span style="color: #0000DD; font-weight: bold">4</span>,
        <span style="background-color: #fff0f0">&#39;min_pw&#39;</span>: min_duties[<span style="color: #0000DD; font-weight: bold">3</span>]<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>,              <span style="color: #888888"># 4.5 * 200 = 900µs</span>
        <span style="background-color: #fff0f0">&#39;max_pw&#39;</span>: (min_duties[<span style="color: #0000DD; font-weight: bold">3</span>]<span style="color: #333333">+</span><span style="color: #6600EE; font-weight: bold">1.7</span>)<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>         <span style="color: #888888"># (4.5+1.7)*200 = 1240µs</span>
    }
}
<span style="color: #888888"># Initialize all servo pins and set them to their default position (pulse width = 0)</span>
<span style="color: #008800; font-weight: bold">for</span> joint, specs <span style="color: #000000; font-weight: bold">in</span> servo_specs<span style="color: #333333">.</span>items():
    pi<span style="color: #333333">.</span>set_mode(specs[<span style="background-color: #fff0f0">&#39;pin&#39;</span>], pigpio<span style="color: #333333">.</span>OUTPUT) <span style="color: #888888"># Set pin mode to OUTPUT</span>
    pi<span style="color: #333333">.</span>set_servo_pulsewidth(specs[<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)
    
<span style="color: #888888"># Function to generate a range of float values with a specified step</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">frange</span>(start, stop, step):
    r <span style="color: #333333">=</span> start
    <span style="color: #008800; font-weight: bold">if</span> step <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">0</span>:
        <span style="color: #008800; font-weight: bold">while</span> r <span style="color: #333333">&lt;</span> stop:
            <span style="color: #008800; font-weight: bold">yield</span> r
            r <span style="color: #333333">+=</span> step
    <span style="color: #008800; font-weight: bold">else</span>:
        <span style="color: #008800; font-weight: bold">while</span> r <span style="color: #333333">&gt;</span> stop:
            <span style="color: #008800; font-weight: bold">yield</span> r
            r <span style="color: #333333">+=</span> step
            
<span style="color: #888888"># Function to move a servo motor to a target pulse width</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">move_servo_slowly</span>(pin, start_pw, end_pw, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">25</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.1</span>):
    <span style="color: #888888"># Determine the movement based on start and end pulse width</span>
    <span style="color: #008800; font-weight: bold">if</span> start_pw <span style="color: #333333">&lt;</span> end_pw:
        pw_range <span style="color: #333333">=</span> frange(start_pw, end_pw, step)
    <span style="color: #008800; font-weight: bold">else</span>:
        pw_range <span style="color: #333333">=</span> frange(start_pw, end_pw, <span style="color: #333333">-</span>step)
    <span style="color: #888888"># Gradually adjust the pulse width and delay to allow smooth movement</span>
    <span style="color: #008800; font-weight: bold">for</span> pw <span style="color: #000000; font-weight: bold">in</span> pw_range:
        pi<span style="color: #333333">.</span>set_servo_pulsewidth(pin, pw)
        time<span style="color: #333333">.</span>sleep(delay)
    pi<span style="color: #333333">.</span>set_servo_pulsewidth(pin, end_pw)
    
<span style="color: #888888"># Function to move servos to their default (home) positions</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">default</span>():
    <span style="color: #888888"># set default points for each servo</span>
    sh_mid <span style="color: #333333">=</span> ((servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">-</span> (<span style="color: #6600EE; font-weight: bold">0.5</span><span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>)
    ba_mid <span style="color: #333333">=</span> ((servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>)
    el_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>])  
    <span style="color: #888888"># Move each servo to its default position</span>
    pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], sh_mid)
    time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
    pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)

    pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], ba_mid)
    time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
    pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)

    pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], el_mid)
    time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
    pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)
    
<span style="color: #888888"># Function to perform a &quot;pick&quot; action using the robotic arm</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">pick</span>(x, y):
    <span style="color: #888888"># Calculate initial midpoints for each joint</span>
    wr_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
    ba_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
    sh_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
    el_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
    <span style="color: #888888"># Move wrist servo to target position</span>
    wr_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>]
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], wr_mid, wr_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
    wr_mid <span style="color: #333333">=</span> wr_target
    <span style="color: #888888"># Move base servo to calculated target position based on `x(find_color_cube)` input</span>
    ba_target <span style="color: #333333">=</span> ba_mid <span style="color: #333333">+</span> (<span style="color: #007020">float</span>(<span style="color: #007020">int</span>((<span style="color: #0000DD; font-weight: bold">315</span> <span style="color: #333333">-</span> x) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">25</span>)) <span style="color: #333333">*</span> <span style="color: #6600EE; font-weight: bold">0.18</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">200</span>)
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], ba_mid, ba_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
    ba_mid <span style="color: #333333">=</span> ba_target
    <span style="color: #888888"># Move elbow servo to its minimum position</span>
    el_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], el_mid, el_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
    el_mid <span style="color: #333333">=</span> el_target
    <span style="color: #888888"># Move shoulder servo to its caculated target</span>
    sh_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> (<span style="color: #6600EE; font-weight: bold">0.2</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">200</span>) <span style="color: #888888"># 0.2 duty ~ 40µs step</span>
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], sh_mid, sh_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">20</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.02</span>)
    sh_mid <span style="color: #333333">=</span> sh_target
    <span style="color: #888888"># Move elbow servo to its caculated target</span>
    el_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>] <span style="color: #333333">+</span> <span style="color: #007020">float</span>(<span style="color: #007020">int</span>((y <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">350</span>) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">25</span>)) <span style="color: #333333">*</span> (<span style="color: #6600EE; font-weight: bold">0.2</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">200</span>)
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], el_mid, el_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
    el_mid <span style="color: #333333">=</span> el_target
    <span style="color: #888888"># Move wrist servo to its caculated target</span>
    wr_target <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], wr_mid, wr_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
    wr_mid <span style="color: #333333">=</span> wr_target
    <span style="color: #888888"># Move shoulder servo to its caculated target</span>
    sh_target <span style="color: #333333">=</span> ((servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">-</span> (<span style="color: #6600EE; font-weight: bold">0.5</span><span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>)
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], sh_mid, sh_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">20</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.02</span>)
    sh_mid <span style="color: #333333">=</span> sh_target
    <span style="color: #888888"># Move elbow servo to its caculated target</span>
    el_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> (<span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>)
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], el_mid, el_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
    el_mid <span style="color: #333333">=</span> el_target
    <span style="color: #888888"># Move base servo to its caculated target</span>
    ba_target <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], ba_mid, ba_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
    ba_mid <span style="color: #333333">=</span> ba_target
    
<span style="color: #888888"># Function to perform returning item to a specified position)</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">release</span>(x, y):
    ba_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
    sh_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>

    ba_target <span style="color: #333333">=</span> ba_mid <span style="color: #333333">+</span> <span style="color: #007020">float</span>(<span style="color: #007020">int</span>((<span style="color: #0000DD; font-weight: bold">300</span> <span style="color: #333333">-</span> x) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">25</span>)) <span style="color: #333333">*</span> (<span style="color: #6600EE; font-weight: bold">0.2</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">200</span>)
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], ba_mid, ba_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
    ba_mid <span style="color: #333333">=</span> ba_target

    sh_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], sh_mid, sh_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
    sh_mid <span style="color: #333333">=</span> sh_target

    pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> (<span style="color: #6600EE; font-weight: bold">0.2</span><span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>))
    time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
    pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)
<span style="color: #888888"># Function to move servos to their default (home) positions when returing the object</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">go_back_default</span>():
    <span style="color: #888888"># Calculate the midpoint of the pulse width range for the shoulder servo</span>
    sh_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
    sh_target <span style="color: #333333">=</span> sh_mid <span style="color: #333333">-</span> (<span style="color: #6600EE; font-weight: bold">0.5</span><span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>)
    <span style="color: #888888"># Gradually move the shoulder servo to the calculated target position</span>
    move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], sh_mid, sh_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
    
<span style="color: #888888"># Function to safely turn off all servo signals and clean up</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">ac_quit</span>():
    <span style="color: #008800; font-weight: bold">for</span> joint, specs <span style="color: #000000; font-weight: bold">in</span> servo_specs<span style="color: #333333">.</span>items():
        pi<span style="color: #333333">.</span>set_servo_pulsewidth(specs[<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)
    pi<span style="color: #333333">.</span>stop()  <span style="color: #888888"># Stop pigpio daemon</span>
            </code></pre>
                
<h3>go_back.py </h3>
<pre><code>
<span style="color: #888888"># Import libraries</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">pygame</span><span style="color: #333333">,</span><span style="color: #0e84b5; font-weight: bold">pigame</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pygame.locals</span> <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">*</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">RPi._GPIO</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">GPIO</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">sys</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">time</span> <span style="color: #008800; font-weight: bold">import</span> sleep
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">sys</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">threading</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">color_detect</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">cd</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">math</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">arm_control</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">ac</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">cv2</span>

<span style="color: #888888"># GPIO setup</span>
GPIO<span style="color: #333333">.</span>setmode(GPIO<span style="color: #333333">.</span>BCM) 
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">19</span>, GPIO<span style="color: #333333">.</span>OUT)  <span style="color: #888888"># Pin for motor A PWM</span>
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">5</span>, GPIO<span style="color: #333333">.</span>OUT) <span style="color: #888888"># Pin for motor A direction</span>
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">6</span>, GPIO<span style="color: #333333">.</span>OUT) <span style="color: #888888"># Pin for motor A direction</span>
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">16</span>, GPIO<span style="color: #333333">.</span>OUT) <span style="color: #888888"># Pin for motor B PWM</span>
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">20</span>, GPIO<span style="color: #333333">.</span>OUT) <span style="color: #888888"># Pin for motor B direction</span>
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">21</span>, GPIO<span style="color: #333333">.</span>OUT) <span style="color: #888888"># Pin for motor B direction</span>

<span style="color: #888888"># Initialize PWM parameters</span>
freq <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">480</span>
duty_cycleA <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #888888"># Initial duty cycle for motor A</span>
duty_cycleB <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #888888"># Initial duty cycle for motor B</span>
pwm24 <span style="color: #333333">=</span> GPIO<span style="color: #333333">.</span>PWM(<span style="color: #0000DD; font-weight: bold">19</span>, freq) <span style="color: #888888"># PWM control for motor A</span>
pwm16 <span style="color: #333333">=</span> GPIO<span style="color: #333333">.</span>PWM(<span style="color: #0000DD; font-weight: bold">16</span>, freq) <span style="color: #888888"># PWM control for motor B</span>
pwm24<span style="color: #333333">.</span>start(duty_cycleA)
pwm16<span style="color: #333333">.</span>start(duty_cycleB)

<span style="color: #888888"># Initialize pygame </span>
pygame<span style="color: #333333">.</span>init()

flag <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
pause <span style="color: #333333">=</span> <span style="color: #007020">False</span>
category <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>
x <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
y <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
approx <span style="color: #333333">=</span> []
checking <span style="color: #333333">=</span> <span style="color: #007020">True</span>

<span style="color: #888888"># Threading lock to manage shared resources</span>
lock <span style="color: #333333">=</span> threading<span style="color: #333333">.</span>Lock()

<span style="color: #888888"># Function to rotate left motor counter-clockwise at a given speed</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">lccw</span>(speed):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> pause:
        GPIO<span style="color: #333333">.</span>output(<span style="color: #0000DD; font-weight: bold">5</span>, GPIO<span style="color: #333333">.</span>HIGH)
        GPIO<span style="color: #333333">.</span>output(<span style="color: #0000DD; font-weight: bold">6</span>, GPIO<span style="color: #333333">.</span>LOW)
        pwm24<span style="color: #333333">.</span>ChangeDutyCycle(speed)

<span style="color: #888888"># Function to rotate right motor clockwise at a given speed</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">rcw</span>(speed):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> pause:
        GPIO<span style="color: #333333">.</span>output(<span style="color: #0000DD; font-weight: bold">21</span>, GPIO<span style="color: #333333">.</span>HIGH)
        GPIO<span style="color: #333333">.</span>output(<span style="color: #0000DD; font-weight: bold">20</span>, GPIO<span style="color: #333333">.</span>LOW)
        pwm16<span style="color: #333333">.</span>ChangeDutyCycle(speed)

<span style="color: #888888"># Function to stop the left motor</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">lstop</span>():
    pwm24<span style="color: #333333">.</span>ChangeDutyCycle(<span style="color: #0000DD; font-weight: bold">0</span>)

<span style="color: #888888"># Function to stop the right motor</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">rstop</span>():
    pwm16<span style="color: #333333">.</span>ChangeDutyCycle(<span style="color: #0000DD; font-weight: bold">0</span>)

<span style="color: #888888"># Main function to run the motor based on color detection</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">run_motor</span>():
    <span style="color: #008800; font-weight: bold">global</span> category, x, y, approx
    desired_center <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">320</span> <span style="color: #888888"># Target x-coordinate for object centering</span>
    proportional_gain <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.6</span>
    dead_zone <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">10</span>
    prev_left_speed <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
    prev_right_speed <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
    max_delta <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5</span> 

    time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">2</span>)
    <span style="color: #888888"># Initial detection loop (keep rotating left motor to find the target)</span>
    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
        <span style="color: #008800; font-weight: bold">with</span> lock:
            category <span style="color: #333333">=</span> cd<span style="color: #333333">.</span>color_name <span style="color: #888888"># Get current detected color</span>
            x <span style="color: #333333">=</span> cd<span style="color: #333333">.</span>cx <span style="color: #888888"># Get x-coordinate of detected object</span>
            y <span style="color: #333333">=</span> cd<span style="color: #333333">.</span>cy <span style="color: #888888"># Get y-coordinate of detected object</span>
            approx <span style="color: #333333">=</span> cd<span style="color: #333333">.</span>approx
        <span style="color: #888888"># Stop initial detection if target color is found</span>
        <span style="color: #008800; font-weight: bold">if</span> category <span style="color: #333333">==</span> cd<span style="color: #333333">.</span>target:
            <span style="color: #008800; font-weight: bold">break</span>

        lccw(<span style="color: #0000DD; font-weight: bold">100</span>) <span style="color: #888888"># Rotate left motor</span>
        time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.15</span>)
        lstop()  <span style="color: #888888"># Stop left motor</span>
        time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.2</span>)
        <span style="color: #888888"># print(&quot;detection00000000000000000000000000: &quot;, category)</span>

    <span style="color: #888888"># Main control loop</span>
    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
        <span style="color: #008800; font-weight: bold">with</span> lock:
            <span style="color: #888888"># if color detection stop, stop the left motor and right motor</span>
            <span style="color: #008800; font-weight: bold">if</span> cd<span style="color: #333333">.</span>stop:
                lstop()
                rstop()
                <span style="color: #008800; font-weight: bold">break</span>
            category <span style="color: #333333">=</span> cd<span style="color: #333333">.</span>color_name <span style="color: #888888"># Get current detected color</span>
            x <span style="color: #333333">=</span> cd<span style="color: #333333">.</span>cx <span style="color: #888888"># Get x-coordinate of detected object</span>
            y <span style="color: #333333">=</span> cd<span style="color: #333333">.</span>cy <span style="color: #888888"># Get y-coordinate of detected object</span>
            approx <span style="color: #333333">=</span> cd<span style="color: #333333">.</span>approx

        <span style="color: #008800; font-weight: bold">if</span>  category <span style="color: #333333">==</span> cd<span style="color: #333333">.</span>target:
            checking <span style="color: #333333">=</span> <span style="color: #007020">False</span>
            <span style="color: #888888"># Calculate error and correction for centering</span>
            object_center <span style="color: #333333">=</span> x
            error <span style="color: #333333">=</span> object_center <span style="color: #333333">-</span> desired_center
            <span style="color: #888888"># move to the right return place, stop both motor</span>
            <span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">abs</span>(error) <span style="color: #333333">&lt;</span> dead_zone:
                lstop()
                rstop()
                <span style="color: #008800; font-weight: bold">continue</span>
            
            <span style="color: #888888"># Adjust to the right return place</span>
            correction <span style="color: #333333">=</span> proportional_gain <span style="color: #333333">*</span> error <span style="color: #333333">/</span> desired_center <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">50</span>
            base_speed <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">80</span>  <span style="color: #888888"># Base motor speed</span>
            left_speed <span style="color: #333333">=</span> base_speed <span style="color: #333333">+</span> correction
            right_speed <span style="color: #333333">=</span> base_speed <span style="color: #333333">-</span> correction
            <span style="color: #888888"># Clamp speeds to allowable range</span>
            left_speed <span style="color: #333333">=</span> <span style="color: #007020">max</span>(<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #007020">min</span>(<span style="color: #0000DD; font-weight: bold">100</span>, left_speed))
            right_speed <span style="color: #333333">=</span> <span style="color: #007020">max</span>(<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #007020">min</span>(<span style="color: #0000DD; font-weight: bold">100</span>, right_speed))
            <span style="color: #888888"># Smooth speed transitions</span>
            left_speed <span style="color: #333333">=</span> <span style="color: #007020">max</span>(prev_left_speed <span style="color: #333333">-</span> max_delta, <span style="color: #007020">min</span>(left_speed, prev_left_speed <span style="color: #333333">+</span> max_delta))
            right_speed <span style="color: #333333">=</span> <span style="color: #007020">max</span>(prev_right_speed <span style="color: #333333">-</span> max_delta, <span style="color: #007020">min</span>(right_speed, prev_right_speed <span style="color: #333333">+</span> max_delta))
            prev_left_speed <span style="color: #333333">=</span> left_speed
            prev_right_speed <span style="color: #333333">=</span> right_speed
            <span style="color: #888888"># Set motor speeds</span>
            lccw(left_speed)
            rcw(right_speed)

            time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.05</span>)
        <span style="color: #008800; font-weight: bold">else</span>:
            lstop()
            rstop()
            time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.1</span>)

<span style="color: #888888"># Main program execution</span>
<span style="color: #008800; font-weight: bold">try</span>:
    cd<span style="color: #333333">.</span>enable_threshold_filter <span style="color: #333333">=</span> <span style="color: #007020">True</span> <span style="color: #888888"># Enable threshold filtering for color detection</span>
    cd<span style="color: #333333">.</span>target <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;Blue&quot;</span> <span style="color: #888888"># Set target color</span>
    cd<span style="color: #333333">.</span>target_pos <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">320</span>  <span style="color: #888888"># Set target position</span>
    ac<span style="color: #333333">.</span>go_back_default() <span style="color: #888888"># Move arm to default position</span>
    
    <span style="color: #888888"># Create threads for motor and color detection</span>
    motor_thread <span style="color: #333333">=</span> threading<span style="color: #333333">.</span>Thread(target<span style="color: #333333">=</span>run_motor)
    detect_thread <span style="color: #333333">=</span> threading<span style="color: #333333">.</span>Thread(target<span style="color: #333333">=</span>cd<span style="color: #333333">.</span>color_detection)
    
    <span style="color: #888888"># Start motor and color detection thread</span>
    motor_thread<span style="color: #333333">.</span>start()
    detect_thread<span style="color: #333333">.</span>start()

    motor_thread<span style="color: #333333">.</span>join()  
    detect_thread<span style="color: #333333">.</span>join() 

    <span style="color: #888888"># Stop PWM signals</span>
    pwm24<span style="color: #333333">.</span>stop()
    pwm16<span style="color: #333333">.</span>stop()

    ac<span style="color: #333333">.</span>default() <span style="color: #888888"># Reset arm to default state</span>
    cap <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>VideoCapture(<span style="color: #0000DD; font-weight: bold">0</span>) <span style="color: #888888"># Start video capture</span>
    color_name <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>
    <span style="color: #008800; font-weight: bold">while</span> color_name <span style="color: #333333">!=</span> cd<span style="color: #333333">.</span>target:
        ret, frame <span style="color: #333333">=</span> cap<span style="color: #333333">.</span>read()
        color_name, x, y, approx <span style="color: #333333">=</span> cd<span style="color: #333333">.</span>find_color_cubes(frame)
    cd<span style="color: #333333">.</span>cd_stop() <span style="color: #888888"># Stop color detection</span>

    ac<span style="color: #333333">.</span>release(x,y) <span style="color: #888888"># Release object using robotic arm</span>
    ac<span style="color: #333333">.</span>ac_quit() <span style="color: #888888"># Quit arm control</span>
    sys<span style="color: #333333">.</span>exit() 

<span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">KeyboardInterrupt</span>:
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Keyboard interrupt received. Cleaning up...&quot;</span>)
<span style="color: #008800; font-weight: bold">finally</span>:
    cd<span style="color: #333333">.</span>cd_stop() <span style="color: #888888"># Color detection stops</span>  
                  </code></pre>
                
<h3>run.sh</h3>
<pre><code>
<span style="color: #888888">#!/usr/bin/env bash</span>
<span style="color: #888888"># Start the pigpio daemon, which is required for GPIO control</span>
sudo pigpiod
<span style="color: #888888"># Infinite loop to continuously execute the Python scripts</span>
<span style="color: #008800; font-weight: bold">while</span> true
do
    <span style="color: #888888"># Run the motor control script</span>
    sudo python3 motor_control<span style="color: #333333">.</span>py
    <span style="color: #888888"># Run the go-back script</span>
    sudo python3 go_back<span style="color: #333333">.</span>py
    <span style="color: #888888"># Optionally, Pause for 1 second before the next iteration</span>
done
                                </code></pre>    
                

      </div>

    </div><!-- /.container -->




    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!-- <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script> -->
  </body>
</html>
