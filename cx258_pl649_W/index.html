
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Autonomous Object Retrieval Robot</title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!-- <link href="../../assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet"> -->

    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <!-- <script src="../../assets/js/ie-emulation-modes-warning.js"></script> -->

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Autonomous Object Retrieval Robot</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#intro">Introduction</a></li>
            <li><a href="#obj">Project Objective</a></li>
            <li><a href="#design">Design</a></li>
            <li><a href="#drawings">Drawings</a></li>
            <li><a href="#testing">Testing</a></li>
            <li><a href="#result">Result</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">

      <div class="starter-template">
        <h1>Autonomous Object Retrieval Robot</h1>
        <p class="lead">ECE5725 2024Fall Project<br>A Project By Chenxin Xun and Pengru Lung.</p>
      </div>

      <hr>
      <div class="center-block">
          <iframe width="640" height="360" src="https://www.youtube.com/embed?v=et91Gea6CPk" frameborder="0" allowfullscreen></iframe>
          <h4 style="text-align:center;">Demonstration Video</h4>
      </div>

      <hr id="intro">

      <div style="text-align:center;">
              <h2>Introduction</h2>
              <p style="text-align: left;padding: 0px 30px;">This project aims to design and build an autonomous object retrieval robot capable of identifying and retrieving objects based on their color. The system utilizes a pair of Raspberry Pi devices, both equipped with cameras, and a robot with an arm featuring servos for object picking. The robot interacts with the user by receiving a color signal through a glove equipped with a camera, searching for the corresponding object, picking it up, and delivering it to the user.</p>
      </div>

    <hr id='obj'>

      <div class="row">
          <div class="col-md-4" style="text-align:center;">
          <img class="img-rounded" src="pics/robot2.jpg" alt="Generic placeholder image" width="377" height="240">
          </div>
          <div class="col-md-8" style="font-size:18px;">
          <h2>Project Objective:</h2>
          <ul>
            <li>Design an autonomous robot capable of identifying objects based on their color.</li>
            <li>Implement a robotic arm with servos for precise object picking and placement.</li>
            <li>Utilize two Raspberry Pi devices, both equipped with cameras, for message transmission and system control.</li>
            <li>Enable user interaction via a camera-equipped glove to specify the desired object color.</li>
            <li>Ensure smooth and reliable object detection, retrieval, and delivery to the user.</li>
          </ul>
          </div>
      </div>

    <hr id='design'>

      <div style="text-align:center;">
              <h2>Design</h2>
              <h3 style="text-align: center; padding: 0px 150px;">Hardware Design</h3>
              <h4 style="text-align: center; padding: 0px 150px;">Glove Design</h4>
              <div style="display: flex; align-items: center;">
            <img class="img-rounded" src="pics/glove.jpg" alt="Generic placeholder image" width="223" height="240" style="margin-right: 35px; margin-left: 25px;">
    <p style="text-align: justify; padding: 0px; max-width: 700px;"> We have mounted the Raspberry Pi 4 and a camera onto the glove. Also, we implemented a button on the Raspberry Pi 4 to control the camera. Using soldering, we connected the button and a 1kΩ resistor, wiring them to GPIO pin 17 and Ground. This setup was thoroughly tested to ensure both the hardware’s stability and the responsiveness of the button control.
    </p>
 </div>
            <h4 style="text-align: center; padding: 0px 150px;">Robot Design</h4>
              <p style="text-align: justify; padding: 0px 150px;">In our robot design, we utilize a Raspberry Pi 4 to control the robot's movements and arm. The robot is equipped with two servos for controlling the arm and two servos for robot movement. The servos are connected to specific GPIO pins on the Raspberry Pi, which are used to send control signals for precise movement. The Raspberry Pi acts as the central control unit, coordinating the servos' actions based on the input from the camera-equipped glove. Our GPIO pin mappings are shown in the table below.</p> 
              <h4 style="text-align: center; padding: 0px 150px;">Table 1: RaspberryPi GPIO Pin to Signal Mapping</h4>
              <table style="width: 100%; text-align: center; padding: 0px 150px; border-collapse: collapse;">
                <tr>
                  <th style="border-bottom: 1px solid #D3D3D3; padding: 8px; text-align: center;">Pi GPIO Pin</th>
                  <th style="border-bottom: 1px solid #D3D3D3; padding: 8px; text-align: center;">Signal Name</th>
                  <tr>
                    <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 4</td>
                    <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Robot wrist rotation control</td>
                  </tr>
                  <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 5</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Direction control for left motor</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 6</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Direction control for left motor</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 12</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Robot arm base rotation control</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 13</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Robot shoulder elevation control</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 16</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">PWM signal for right motor</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 19</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">PWM signal for left motor</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 20</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Direction control for right motor</td>
                </tr>
                <tr>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 21</td>
                  <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Direction control for right motor</td>
                  <tr>
                    <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">GPIO 26</td>
                    <td style="border-bottom: 1px solid #D3D3D3; padding: 8px;">Robot elbow joint control</td>
              </table>   
              <h3 style="text-align: center; padding: 0px 150px;">Software Design</h3>
              <h4 style="text-align: center; padding: 0px 150px;">Glove Design</h4>
              <p style="text-align: justify; padding: 0px 150px;">The software design for the device is centered around detecting and identifying color-coded objects using computer vision techniques and sending the detected color to the robot. The program utilizes the OpenCV library (cv2) for real-time image processing, where the camera feed is continuously captured and analyzed to detect specific color cubes.</p>
              <p style="text-align: justify; padding: 0px 150px;">1. The Color Detection: The color detection is based on the HSV color space, with predefined ranges for different colors (Green, Blue, Yellow). The software first captures a frame from the camera, converts it to the HSV color space, and then applies a mask to isolate regions of the image matching the color ranges. Contours of these regions are found and used to calculate the center of the object.</p>
              <p style="text-align: justify; padding: 0px 150px;">2. System Integration: A button is used to trigger the color detection process, allowing the user to initiate the system when desired. The system utilizes Wi-Fi communication to transmit the detected color information. Once the color is detected, the software sends the color information via a socket connection over Wi-Fi to a remote server. This ensures the robot is informed of the object’s color for further action in real-time.</p>
              <h4 style="text-align: center; padding: 0px 150px;">Robot Design</h4>
              <p style="text-align: justify; padding: 0px 150px;">1. Server: The robot's communication system uses Wi-Fi for seamless data exchange with the camera-equipped glove. The robot acts as a server, listening for connections on a specific IP and port, while the glove connects as a client. Upon receiving signals from the glove, the server decodes the data and triggers actions based on the detected color. This setup ensures real-time, efficient coordination between the glove and the robot. </p> 
              <p style="text-align: justify; padding: 0px 150px;">2. Arm control: This code implements a robotic arm control system using the pigpio library on a Raspberry Pi, with functions to smoothly operate servo motors. Each servo (base, shoulder, elbow, and wrist) is configured with specific GPIO pins and defined pulse width ranges for movement. A helper function ensures gradual transitions between positions to prevent jerky motions. High-level functions like default, pick, and release coordinate multiple servo movements to perform actions such as returning to a home position, picking up objects at specified coordinates, and placing them down. The system also includes a cleanup function to safely stop the servos and disconnect from the pigpio daemon. This structured approach provides precise and smooth control over the robotic arm’s movements.</p>
              <p style="text-align: justify; padding: 0px 150px;">3. Color detect: This code implements real-time color-based object detection using OpenCV. It uses a webcam feed to identify and track colored cubes within a specified color range (e.g., Green, Blue, Yellow). The HSV color space is used to define thresholds for six colors, and contours are extracted from binary masks to locate the objects. The centroid and approximate shape of each detected object are calculated and displayed on the video feed, along with HSV values at the object's center. A threshold filter can optionally be enabled to ignore objects below a minimum Y-coordinate. The program uses threading to handle shared variables like the detected color and object position, ensuring thread-safe updates. If a detected object matches the target color and crosses a set Y-coordinate threshold, the system stops further detection and releases resources, such as the webcam feed and OpenCV windows. This program is useful for applications like object tracking and robotic control based on visual inputs.</p>
              <p style="text-align: justify; padding: 0px 150px;">4. Motor control: This code integrates robotic motor control, computer vision, and server communication to detect a target object by its color, track it using motors, and manipulate it with a robotic arm. It uses the pygame library for GUI initialization, RPi.GPIO for motor control, and a custom module for color detection. The system fetches the target color from a server, calibrates motor control for specific positions, and uses threading to run motor control and color detection simultaneously. The motor control logic employs proportional control to align the motors with the target's position. Once the object is detected, the robotic arm picks it up and can later release it at a specified location. Robust exception handling ensures a safe cleanup of resources, stopping motors and color detection on exit. This framework provides a synchronized and automated robotic system for object detection and manipulation.</p>
              <p style="text-align: justify; padding: 0px 150px;">5. run (Integration): This bash script sets up a continuous loop to manage the execution of two Python scripts (motor_control.py and go_back.py) for controlling a robotic system. It starts by launching the pigpiod daemon, which is essential for managing GPIO operations on a Raspberry Pi. The loop ensures that the motor control script runs first, followed by a script to reset or reposition the robotic components (go-back script). An optional delay can be added between iterations for system stability. This script provides a simple and automated way to repeatedly execute the required control routines for the robotic system</p>

      </div>

    <hr id='drawings'>

      <div style="text-align:center;">
              <h2>Drawings</h2>
      </div>

      <div class="row" style="text-align:center;">
        <div style="text-align:center;">
            <img class="img-rounded" src="pics/flow.png" alt="Generic placeholder image" style="width:80%;">
            <h4>Flow chart</h4>
        </div>
        <div style="text-align:center;">
          <img class="img-rounded" src="pics/drawing.jpg" alt="Generic placeholder image" style="width:80%;">
          <h4>hand drawing</h4>
      </div>
    </div>

    <hr id='testing'>

      <div style="text-align:center;">
              <h2>Testing</h2>
              <p style="text-align: left;padding: 0px 30px;">In our testing, we conducted separate tests for the glove and the robot. We tested the glove by pointing it at a specific color and printing the color. For the robot, we tested it by placing a ball in front of it, and the robot was able to pick up the ball. With the basic tests passed, we also implemented additional tests, such as ensuring the robot can ignore balls of different colors and pick up only the assigned color. Additionally, we tested its ability to detect the blue bar and return it to the designated location.</p>
              <p style="text-align: left;padding: 0px 30px;">After thoroughly testing these two devices, we performed system integration. In this test, the glove points to a color, and the glove sends the color to the robot. The robot should follow the color contained in the message, go pick up the ball, and return it to its designated location.</p>
              <p style="text-align: left;padding: 0px 30px;">In our testing, sometimes the robot can pick up the ball correctly, but there are instances where it does not work as expected. In some cases, we need to perform calibration. Additionally, due to some multithreading issues, the camera did not close correctly, causing the video to reopen unexpectedly. In general, we need to recalibrate the robot after approximately 10 pickups. Also, when the robot continuously picks up and returns balls without restarting the program, the camera may encounter issues opening properly. However, once the calibration is complete and the program is restarted, the robot can perform the task of picking up different balls in most situations.</p>
      </div>

    <hr id='result'>

      <div style="text-align:center;">
              <h2>Result</h2>
              <p style="text-align: left;padding: 0px 30px;">In conclusion, we have the glove point to a specific color and use Wi-Fi transmission to send the assigned color to the robot. The robot can detect the specific color ball, move towards it, pick it up, and return the ball to the designated position. We have our demonstration in the video above. In this project, we still need to improve reliability, whether by using more decision-making processes to determine whether the ball has been picked up, performing calibration automatically, adding PID control to regulate the signal, or improving multithreading for more stable performance.</p>
              <p style="text-align: left;padding: 0px 30px;">All in all, we consider this five-week project to be a significant achievement and a great learning experience.</p>
    <hr>
    <!-- <hr id='work'>
    <div class="row" style="text-align:center;">
          <h2>Work Distribution</h2>
          <div style="text-align:center;">

          </div>
          <div class="col-md-6" style="font-size:16px">
              <img class="img-rounded" src="pics/a.png" alt="Generic placeholder image" width="240" height="240">
              <h3>Chenxin Xun</h3>
              <p class="lead">cx258@cornell.edu</p>
              <p>Robot Movement and Object Retrieval Design
          </div>
          <div class="col-md-6" style="font-size:16px">
              <img class="img-rounded" src="pics/b.png" alt="Generic placeholder image" width="240" height="240">
              <h3>Peng-Ru Lung</h3>
              <p class="lead">pl649@cornell.edu</p>
              <p>Design of Camera-Equipped Glove and Transmission System 
          </div>
      </div>
      <hr> -->
      <div style="font-size:18px; text-align: left;">
          <h2>Parts List</h2>            
          <ul>
              <li>Raspberry Pi 4 $35.00</li>
              <li>Raspberry Pi Camera V2 $20.00</li>
              <li>Raspberry Pi Camera V2 $20.00</li>
              <a href="https://www.amazon.com/dp/B081YH77C3?ref=ppx%20yo2ov%20dt%20b%20fed%20asin%20title"><li>Robot Arm - $22.13</li></a>
              <li>Resistors, Wires and Buttons- Provided in lab</li>
          </ul>
          <h3>Total: $97.13</h3>
        </div>
        <hr>
        <div style="font-size:18px; text-align: left;">
            <h2>References</h2>
            <a style="font-size: 18px; text-align: left;">
          <a href="https://picamera.readthedocs.io/">PiCamera Document</a><br>
          <a href="http://www.micropik.com/PDF/SG90Servo.pdf">Tower Pro Servo Datasheet</a><br>
          <a href="http://abyz.co.uk/rpi/pigpio/">Pigpio Library</a><br>
          <a href="https://sourceforge.net/p/raspberry-gpio-python/wiki/Home/">R-Pi GPIO Document</a><br>
          <a href="https://projects.raspberrypi.org/en/projects/get-started-pico-w/3">Open a Socket</a><br>
          <a href="https://github.com/automaticdai/rpi-object-detection">Object detecion</a><br>

      </div>

      <hr>

      <div style="font-size:18px; text-align: left;">
              <h2>Code Appendix</h2>
              <pre><code>
//color_detect_send.py (the code for the glove)
<span style="color: #888888"># Authors:  Chenxin Xun (cx258)</span>
<span style="color: #888888">#           Pengru Lung (pl649)</span>
<span style="color: #888888"># Final project, Monday Section</span>
<span style="color: #888888"># 2024-12-13</span>
<span style="color: #008800; font-weight: bold">import</span><span style="color: #0e84b5; font-weight: bold">socket</span> <span style="color: #888888"># For video capture and image processing</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">threading</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">socket</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">RPi._GPIO</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">GPIO</span> <span style="color: #888888"># For Raspberry Pi GPIO control</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>
<span style="color: #888888"># Configure GPIO settings</span>
GPIO<span style="color: #333333">.</span>setmode(GPIO<span style="color: #333333">.</span>BCM)
GPIO<span style="color: #333333">.</span>setup(<span style="color: #0000DD; font-weight: bold">17</span>, GPIO<span style="color: #333333">.</span>IN, pull_up_down<span style="color: #333333">=</span>GPIO<span style="color: #333333">.</span>PUD_UP)

stop <span style="color: #333333">=</span> <span style="color: #007020">False</span> 
cap <span style="color: #333333">=</span> <span style="color: #007020">None</span>
lock <span style="color: #333333">=</span> threading<span style="color: #333333">.</span>Lock()
color_name <span style="color: #333333">=</span> &#39;&#39;</span>

<span style="color: #888888"># Server connection IP address and port number</span>
HOST <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;10.49.240.92&#39;</span>
PORT <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5000</span>        

<span style="color: #888888"># Define HSV color ranges for different colors</span>
color_ranges <span style="color: #333333">=</span> {
    <span style="background-color: #fff0f0">&quot;Green&quot; </span>: ([<span style="color: #0000DD; font-weight: bold">45</span>, <span style="color: #0000DD; font-weight: bold">35</span>, <span style="color: #0000DD; font-weight: bold">35</span>], [<span style="color: #0000DD; font-weight: bold">75</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),    
    <span style="background-color: #fff0f0">&quot;Blue&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">105</span>, <span style="color: #0000DD; font-weight: bold">125</span>, <span style="color: #0000DD; font-weight: bold">125</span>], [<span style="color: #0000DD; font-weight: bold">135</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),  
    <span style="background-color: #fff0f0">&quot;Yellow&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">20</span>, <span style="color: #0000DD; font-weight: bold">180</span>, <span style="color: #0000DD; font-weight: bold">180</span>], [<span style="color: #0000DD; font-weight: bold">40</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]), 
}

<span style="color: #888888"># Function to identify the main color in a frame</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">find_main_color</span>(frame):
    <span style="color: #888888"># Convert the frame to HSV color space</span>
    hsv_frame <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(frame, cv2<span style="color: #333333">.</span>COLOR_BGR2HSV)

    <span style="color: #888888"># Initialize to store color count</span>
    color_count <span style="color: #333333">=</span> {color: <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #008800; font-weight: bold">for</span> color <span style="color: #000000; font-weight: bold">in</span> color_ranges}
    <span style="color: #888888"># Loop through each color range and apply a mask</span>
    <span style="color: #008800; font-weight: bold">for</span> color_name, (lower, upper) <span style="color: #000000; font-weight: bold">in</span> color_ranges<span style="color: #333333">.</span>items():
        <span style="color: #888888"># Create lower and upper bound arrays</span>
        lower_bound <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array(lower, dtype<span style="color: #333333">=</span>np<span style="color: #333333">.</span>uint8)
        upper_bound <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array(upper, dtype<span style="color: #333333">=</span>np<span style="color: #333333">.</span>uint8)

        <span style="color: #888888"># Create a binary mask where color is detected</span>
        mask <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>inRange(hsv_frame, lower_bound, upper_bound)

        <span style="color: #888888"># Count the number of pixels matching the color</span>
        color_count[color_name] <span style="color: #333333">=</span> np<span style="color: #333333">.</span>sum(mask)  <span style="color: #888888"># Sum the pixels that match the color</span>

    <span style="color: #888888"># Determine the main color (the one with the highest count)</span>
    main_color <span style="color: #333333">=</span> <span style="color: #007020">max</span>(color_count, key<span style="color: #333333">=</span>color_count<span style="color: #333333">.</span>get)
    <span style="color: #888888"># Ignore insignificant detections</span>
    <span style="color: #008800; font-weight: bold">if</span> color_count[main_color] <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">300</span>:
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>
    <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;The main color detected is: {main_color}&quot;</span>)
    <span style="color: #008800; font-weight: bold">return</span> main_color

<span style="color: #888888"># Function to send the detected color to a server</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">send_color</span>(message):
    <span style="color: #888888"># Create a client socket </span>
    client_socket <span style="color: #333333">=</span> socket<span style="color: #333333">.</span>socket(socket<span style="color: #333333">.</span>AF_INET, socket<span style="color: #333333">.</span>SOCK_STREAM)
    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
        <span style="color: #008800; font-weight: bold">try</span>:
            <span style="color: #888888"># Try to connect to the server</span>
            client_socket<span style="color: #333333">.</span>connect((HOST, PORT))
            <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Connected to the server successfully.&quot;</span>)
            <span style="color: #008800; font-weight: bold">break</span>  <span style="color: #888888"># Exit the loop once connected</span>
        <span style="color: #008800; font-weight: bold">except</span> socket<span style="color: #333333">.</span>error <span style="color: #008800; font-weight: bold">as</span> e:
            <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;Connection failed: {e}. Retrying in 5 seconds...&quot;</span>)
            time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">5</span>)  <span style="color: #888888"># Wait for 5 seconds before retrying</span>

    <span style="color: #888888"># Send the encoded message to the server</span>
    client_socket<span style="color: #333333">.</span>send(message<span style="color: #333333">.</span>encode(<span style="background-color: #fff0f0">&#39;utf-8&#39;</span>))
    time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">3</span>) 

    <span style="color: #888888"># Close the connection</span>
    client_socket<span style="color: #333333">.</span>close()
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Connection closed.&quot;</span>)

<span style="color: #888888"># Function to handle color detection    </span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">color_detection</span>():
    <span style="color: #008800; font-weight: bold">global</span> stop, cap, color_name
    cap <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>VideoCapture(<span style="color: #0000DD; font-weight: bold">0</span>)  <span style="color: #888888"># Open the default camera</span>
    
    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
        ret, frame <span style="color: #333333">=</span> cap<span style="color: #333333">.</span>read() <span style="color: #888888"># Capture a frame</span>
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> ret:
            cd_stop() <span style="color: #888888"># Stop if no frame is captured</span>
            <span style="color: #008800; font-weight: bold">break</span>

        <span style="color: #888888"># Process the frame to find color cubes</span>
        <span style="color: #008800; font-weight: bold">with</span> lock:
            color_name <span style="color: #333333">=</span> find_main_color(frame) <span style="color: #888888"># Detect main color</span>
        <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;color_detection:::::::::::::::::::&quot;</span>, color_name)  
        time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.5</span>)  
        <span style="color: #888888"># If a recognized color is detected, send it to the server</span>
        <span style="color: #008800; font-weight: bold">if</span> (color_name<span style="color: #333333">==</span><span style="background-color: #fff0f0">&quot;Green&quot;</span> <span style="color: #000000; font-weight: bold">or</span> color_name<span style="color: #333333">==</span><span style="background-color: #fff0f0">&quot;Yellow&quot;</span> <span style="color: #000000; font-weight: bold">or</span> color_name<span style="color: #333333">==</span><span style="background-color: #fff0f0">&quot;Blue&quot;</span>):
            message <span style="color: #333333">=</span> f<span style="background-color: #fff0f0">&quot;{color_name}&quot;</span>
            cd_stop()
            send_color(message)

        <span style="color: #888888"># Exit the loop if &#39;q&#39; is pressed</span>
        <span style="color: #008800; font-weight: bold">if</span> cv2<span style="color: #333333">.</span>waitKey(<span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xFF</span> <span style="color: #333333">==</span> <span style="color: #007020">ord</span>(<span style="background-color: #fff0f0">&#39;q&#39;</span>):
            stop <span style="color: #333333">=</span> <span style="color: #007020">True</span>
            cd_stop()
            <span style="color: #008800; font-weight: bold">break</span>
<span style="color: #888888"># Function to clean up video capture resources</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">cd_stop</span>():
    <span style="color: #008800; font-weight: bold">global</span> cap
    cap<span style="color: #333333">.</span>release() <span style="color: #888888"># Release the camera</span>
    cv2<span style="color: #333333">.</span>destroyAllWindows() <span style="color: #888888"># Close all OpenCV windows</span>

<span style="color: #008800; font-weight: bold">try</span>:
    <span style="color: #008800; font-weight: bold">while</span>(<span style="color: #007020">True</span>):
        flag17 <span style="color: #333333">=</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">17</span>) <span style="color: #888888"># Monitor GPIO pin 17 for input</span>
        <span style="color: #008800; font-weight: bold">while</span>(flag17): 
            time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.1</span>)  
            flag17 <span style="color: #333333">=</span> GPIO<span style="color: #333333">.</span>input(<span style="color: #0000DD; font-weight: bold">17</span>)
            <span style="color: #008800; font-weight: bold">if</span> flag17<span style="color: #333333">==</span><span style="color: #0000DD; font-weight: bold">0</span>: <span style="color: #888888"># Start color detection when flag17 is low</span>
                color_detection()
<span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">KeyboardInterrupt</span>:
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Keyboard interrupt received. Cleaning up...&quot;</span>)
<span style="color: #008800; font-weight: bold">finally</span>:
    GPIO<span style="color: #333333">.</span>cleanup() <span style="color: #888888"># Reset GPIO pins</span>
    cd_stop()  <span style="color: #888888"># Release camera and clean up resources</span>
                </code></pre>
              <pre><code>
// color_detect.py
<span style="color: #888888"># Authors:  Chenxin Xun (cx258)</span>
<span style="color: #888888">#           Pengru Lung (pl649)</span>
<span style="color: #888888"># Final project, Monday Section</span>
<span style="color: #888888"># 2024-12-13</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">cv2</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">threading</span>
<span style="color: #888888"># from server_color import data</span>

stop <span style="color: #333333">=</span> <span style="color: #007020">False</span>
cap <span style="color: #333333">=</span> <span style="color: #007020">None</span> <span style="color: #888888"># Video capture object</span>
lock <span style="color: #333333">=</span> threading<span style="color: #333333">.</span>Lock()
color_name <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;&#39;</span> <span style="color: #888888"># Detected color name</span>
cx <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span> 
cy <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
approx <span style="color: #333333">=</span> [] <span style="color: #888888"># Approximated contour points for the detected cube</span>
target <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;Blue&#39;</span>
target_pos <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">305</span> <span style="color: #888888"># Y-coordinate threshold to trigger a stop</span>
step_stop <span style="color: #333333">=</span> <span style="color: #007020">False</span>

<span style="color: #888888"># New variables for threshold filtering</span>
enable_threshold_filter <span style="color: #333333">=</span> <span style="color: #007020">False</span>
min_y_threshold <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">130</span>

<span style="color: #888888"># Define HSV color ranges for seven different colors</span>
color_ranges <span style="color: #333333">=</span> {
    <span style="background-color: #fff0f0">&quot;Green&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">36</span>, <span style="color: #0000DD; font-weight: bold">25</span>, <span style="color: #0000DD; font-weight: bold">25</span>], [<span style="color: #0000DD; font-weight: bold">86</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),
    <span style="background-color: #fff0f0">&quot;Blue&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">94</span>, <span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">2</span>], [<span style="color: #0000DD; font-weight: bold">126</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),
    <span style="background-color: #fff0f0">&quot;Yellow&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">20</span>, <span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">80</span>], [<span style="color: #0000DD; font-weight: bold">30</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),
    <span style="background-color: #fff0f0">&quot;Orange&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">3</span>, <span style="color: #0000DD; font-weight: bold">80</span>, <span style="color: #0000DD; font-weight: bold">100</span>], [<span style="color: #0000DD; font-weight: bold">12</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),
    <span style="background-color: #fff0f0">&quot;Purple&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">130</span>, <span style="color: #0000DD; font-weight: bold">50</span>, <span style="color: #0000DD; font-weight: bold">50</span>], [<span style="color: #0000DD; font-weight: bold">160</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>]),
    <span style="background-color: #fff0f0">&quot;Cyan&quot;</span>: ([<span style="color: #0000DD; font-weight: bold">85</span>, <span style="color: #0000DD; font-weight: bold">100</span>, <span style="color: #0000DD; font-weight: bold">100</span>], [<span style="color: #0000DD; font-weight: bold">95</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">255</span>])
}

<span style="color: #888888"># Function to find and identify color cubes in a frame</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">find_color_cubes</span>(frame):
    <span style="color: #888888"># Convert the frame to HSV color space</span>
    hsv_frame <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(frame, cv2<span style="color: #333333">.</span>COLOR_BGR2HSV)
    <span style="color: #888888"># Loop through each defined color range</span>
    <span style="color: #008800; font-weight: bold">for</span> c_name, (lower, upper) <span style="color: #000000; font-weight: bold">in</span> color_ranges<span style="color: #333333">.</span>items():
        lower_bound <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array(lower, dtype<span style="color: #333333">=</span>np<span style="color: #333333">.</span>uint8)
        upper_bound <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array(upper, dtype<span style="color: #333333">=</span>np<span style="color: #333333">.</span>uint8)

        <span style="color: #888888"># Create a binary mask where color is detected</span>
        mask <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>inRange(hsv_frame, lower_bound, upper_bound)
        mask <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>erode(mask, <span style="color: #007020">None</span>, iterations<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #888888"># Remove noise</span>
        mask <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>dilate(mask, <span style="color: #007020">None</span>, iterations<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #888888"># Enhance detected regions</span>

        <span style="color: #888888"># Find contours in the mask</span>
        contours, _ <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>findContours(mask, cv2<span style="color: #333333">.</span>RETR_EXTERNAL, cv2<span style="color: #333333">.</span>CHAIN_APPROX_SIMPLE)

        <span style="color: #008800; font-weight: bold">for</span> contour <span style="color: #000000; font-weight: bold">in</span> contours:
            area <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>contourArea(contour)
            <span style="color: #008800; font-weight: bold">if</span> area <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">300</span>:  <span style="color: #888888"># Adjust area threshold as needed</span>
                <span style="color: #888888"># Approximate the contour&#39;s shape</span>
                epsilon <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.02</span> <span style="color: #333333">*</span> cv2<span style="color: #333333">.</span>arcLength(contour, <span style="color: #007020">True</span>)
                approx_pts <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>approxPolyDP(contour, epsilon, <span style="color: #007020">True</span>)

                <span style="color: #888888"># Calculate the center of the contour</span>
                M <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>moments(contour)
                <span style="color: #008800; font-weight: bold">if</span> M[<span style="background-color: #fff0f0">&quot;m00&quot;</span>] <span style="color: #333333">!=</span> <span style="color: #0000DD; font-weight: bold">0</span>:
                    cx_local <span style="color: #333333">=</span> <span style="color: #007020">int</span>(M[<span style="background-color: #fff0f0">&quot;m10&quot;</span>] <span style="color: #333333">/</span> M[<span style="background-color: #fff0f0">&quot;m00&quot;</span>])
                    cy_local <span style="color: #333333">=</span> <span style="color: #007020">int</span>(M[<span style="background-color: #fff0f0">&quot;m01&quot;</span>] <span style="color: #333333">/</span> M[<span style="background-color: #fff0f0">&quot;m00&quot;</span>])
                <span style="color: #008800; font-weight: bold">else</span>:
                    cx_local, cy_local <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>

                <span style="color: #888888"># Apply the threshold filter if enabled</span>
                <span style="color: #008800; font-weight: bold">if</span> enable_threshold_filter <span style="color: #000000; font-weight: bold">and</span> cy_local <span style="color: #333333">&lt;</span> min_y_threshold:
                    <span style="color: #888888"># Skip this contour since it&#39;s below the minimum y-threshold</span>
                    <span style="color: #008800; font-weight: bold">continue</span>

                <span style="color: #888888"># If the centroid is within the frame, print RGB values</span>
                <span style="color: #008800; font-weight: bold">if</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #333333">&lt;=</span> cx_local <span style="color: #333333">&lt;</span> frame<span style="color: #333333">.</span>shape[<span style="color: #0000DD; font-weight: bold">1</span>] <span style="color: #000000; font-weight: bold">and</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #333333">&lt;=</span> cy_local <span style="color: #333333">&lt;</span> frame<span style="color: #333333">.</span>shape[<span style="color: #0000DD; font-weight: bold">0</span>]:
                    rgb_values <span style="color: #333333">=</span> frame[cy_local, cx_local]
                    <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;RGB values at ({cx_local}, {cy_local}): {rgb_values}&quot;</span>)

                <span style="color: #888888"># Draw the contour and label on the frame</span>
                cv2<span style="color: #333333">.</span>drawContours(frame, [approx_pts], <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>, (<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">0</span>), <span style="color: #0000DD; font-weight: bold">2</span>)
                cv2<span style="color: #333333">.</span>putText(frame, f<span style="background-color: #fff0f0">&quot;{c_name} Cube&quot;</span>, (cx_local, cy_local <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">10</span>), cv2<span style="color: #333333">.</span>FONT_HERSHEY_SIMPLEX, <span style="color: #6600EE; font-weight: bold">0.5</span>, (<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">0</span>), <span style="color: #0000DD; font-weight: bold">2</span>)
                cv2<span style="color: #333333">.</span>circle(frame, (cx_local, cy_local), <span style="color: #0000DD; font-weight: bold">5</span>, (<span style="color: #0000DD; font-weight: bold">255</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>), <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>)
                <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;Detected {c_name} cube at position: ({cx_local}, {cy_local})&quot;</span>)

                <span style="color: #008800; font-weight: bold">return</span> c_name, cx_local, cy_local, approx_pts <span style="color: #888888"># Return detected cube info</span>

    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>, []  <span style="color: #888888"># Return default values if no color cube found</span>

<span style="color: #888888"># Function for real-time color detection</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">color_detection</span>():
    <span style="color: #008800; font-weight: bold">global</span> stop, cap, color_name, cx, cy, approx
    cap <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>VideoCapture(<span style="color: #0000DD; font-weight: bold">0</span>)  <span style="color: #888888"># Open the default camera</span>

    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
        <span style="color: #888888"># print(&quot;Target::::::::::::::::::&quot;, target)</span>
        ret, frame <span style="color: #333333">=</span> cap<span style="color: #333333">.</span>read()
        <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> ret:  <span style="color: #888888"># If frame capture fails, stop the program</span>
            cd_stop()
            <span style="color: #008800; font-weight: bold">break</span>
        <span style="color: #888888"># Detect color cubes in the current frame</span>
        color_name1, cx1, cy1, approx1 <span style="color: #333333">=</span> find_color_cubes(frame)
        <span style="color: #888888"># Process the frame to find color cubes</span>
        <span style="color: #008800; font-weight: bold">with</span> lock:
            color_name <span style="color: #333333">=</span> color_name1
            cx <span style="color: #333333">=</span> cx1
            cy <span style="color: #333333">=</span> cy1
            approx <span style="color: #333333">=</span> approx1
            <span style="color: #888888"># Stop if &#39;q&#39; is pressed or the target conditions are met</span>
            <span style="color: #008800; font-weight: bold">if</span> cv2<span style="color: #333333">.</span>waitKey(<span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xFF</span> <span style="color: #333333">==</span> <span style="color: #007020">ord</span>(<span style="background-color: #fff0f0">&#39;q&#39;</span>):
                stop <span style="color: #333333">=</span> <span style="color: #007020">True</span>
                cd_stop()
                <span style="color: #008800; font-weight: bold">break</span>

            <span style="color: #008800; font-weight: bold">if</span> cy <span style="color: #333333">&gt;</span> target_pos <span style="color: #000000; font-weight: bold">and</span> target <span style="color: #333333">==</span> color_name:
                stop <span style="color: #333333">=</span> <span style="color: #007020">True</span>
                cd_stop()
                <span style="color: #008800; font-weight: bold">break</span>

            <span style="color: #008800; font-weight: bold">if</span> cy <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">260</span> <span style="color: #000000; font-weight: bold">and</span> target <span style="color: #333333">==</span> color_name:
                step_stop <span style="color: #333333">=</span> <span style="color: #007020">True</span>
                
<span style="color: #888888"># Function to release resources and close windows</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">cd_stop</span>():
    <span style="color: #008800; font-weight: bold">global</span> cap
    cap<span style="color: #333333">.</span>release()  <span style="color: #888888"># Release the video capture object</span>
    cv2<span style="color: #333333">.</span>destroyAllWindows() <span style="color: #888888"># Close all OpenCV windows</span>
              </code></pre>
              <pre><code>
//Server_color.py
<span style="color: #888888"># Authors:  Chenxin Xun (cx258)</span>
<span style="color: #888888">#           Pengru Lung (pl649)</span>
<span style="color: #888888"># Final project, Monday Section</span>
<span style="color: #888888"># 2024-12-13</span>
<span style="color: #0e84b5; font-weight: bold">import socket</span>
<span style="color: #888888"># Function to handle receiving color data from a client</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">sending_color</span>():
  <span style="color: #008800; font-weight: bold">global</span> data
  <span style="color: #888888"># Server configuration</span>
  HOST <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;10.49.240.92&#39;</span> <span style="color: #888888"># Server&#39;s IP address</span>
  PORT <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5000</span>      <span style="color: #888888"># Port to listen on</span>

  <span style="color: #888888"># Create a socket</span>
  server_socket <span style="color: #333333">=</span> socket<span style="color: #333333">.</span>socket(socket<span style="color: #333333">.</span>AF_INET, socket<span style="color: #333333">.</span>SOCK_STREAM)
  <span style="color: #888888"># Allow address reuse</span>
  server_socket<span style="color: #333333">.</span>setsockopt(socket<span style="color: #333333">.</span>SOL_SOCKET, socket<span style="color: #333333">.</span>SO_REUSEADDR, <span style="color: #0000DD; font-weight: bold">1</span>)  
  <span style="color: #888888"># Bind the socket to the specified IP and port</span>
  server_socket<span style="color: #333333">.</span>bind((HOST, PORT)) 
  <span style="color: #888888"># Listen for incoming connections (1 client at a time)</span>
  server_socket<span style="color: #333333">.</span>listen(<span style="color: #0000DD; font-weight: bold">1</span>) 

  <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Server is waiting for a connection...&quot;</span>)

  <span style="color: #888888"># Accept a connection</span>
  client_socket, client_address <span style="color: #333333">=</span> server_socket<span style="color: #333333">.</span>accept()
  <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;Connected by {client_address}&quot;</span>)

  <span style="color: #888888"># Receive data</span>
  data <span style="color: #333333">=</span> client_socket<span style="color: #333333">.</span>recv(<span style="color: #0000DD; font-weight: bold">1024</span>)<span style="color: #333333">.</span>decode(<span style="background-color: #fff0f0">&#39;utf-8&#39;</span>)
  <span style="color: #008800; font-weight: bold">print</span>(f<span style="background-color: #fff0f0">&quot;Received: {data}&quot;</span>)

  <span style="color: #888888"># Close the client and server sockets to clean up resources</span>
  client_socket<span style="color: #333333">.</span>close()
  server_socket<span style="color: #333333">.</span>close()
          </code></pre>
                <pre><code>
// arm_control.py
<span style="color: #888888"># Authors:  Chenxin Xun (cx258)</span>
<span style="color: #888888">#           Pengru Lung (pl649)</span>
<span style="color: #888888"># Final project, Monday Section</span>
<span style="color: #888888"># 2024-12-13</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">pigpio</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>
  <span style="color: #888888"># Initialize pigpio and check connection</span>
  pi <span style="color: #333333">=</span> pigpio<span style="color: #333333">.</span>pi()
  <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> pi<span style="color: #333333">.</span>connected:
      <span style="color: #007020">exit</span>(<span style="background-color: #fff0f0">&quot;Failed to connect to pigpio daemon&quot;</span>) <span style="color: #888888"># Exit if unable to connect</span>
  <span style="color: #888888"># Define the minimum duty cycles for each servo motor</span>
  min_duties <span style="color: #333333">=</span> [<span style="color: #6600EE; font-weight: bold">4.3</span>, <span style="color: #6600EE; font-weight: bold">5.8</span>, <span style="color: #0000DD; font-weight: bold">4</span>, <span style="color: #0000DD; font-weight: bold">5</span>]
  <span style="color: #888888"># Define specifications for each servo motor (pin numbers and pulse width ranges)</span>
  servo_specs <span style="color: #333333">=</span> {
      <span style="background-color: #fff0f0">&#39;base&#39;</span>: {
          <span style="background-color: #fff0f0">&#39;pin&#39;</span>: <span style="color: #0000DD; font-weight: bold">12</span>,
          <span style="background-color: #fff0f0">&#39;min_pw&#39;</span>: min_duties[<span style="color: #0000DD; font-weight: bold">0</span>]<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>,              <span style="color: #888888"># e.g. 4 * 200 = 800µs</span>
          <span style="background-color: #fff0f0">&#39;max_pw&#39;</span>: (min_duties[<span style="color: #0000DD; font-weight: bold">0</span>]<span style="color: #333333">+</span><span style="color: #6600EE; font-weight: bold">8.5</span>)<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>         <span style="color: #888888"># e.g. (4+8.5)*200 = 2500µs</span>
      },
      <span style="background-color: #fff0f0">&#39;shoulder&#39;</span>: {
          <span style="background-color: #fff0f0">&#39;pin&#39;</span>: <span style="color: #0000DD; font-weight: bold">13</span>,
          <span style="background-color: #fff0f0">&#39;min_pw&#39;</span>: min_duties[<span style="color: #0000DD; font-weight: bold">1</span>]<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>,              <span style="color: #888888"># 5.5 * 200 = 1100µs</span>
          <span style="background-color: #fff0f0">&#39;max_pw&#39;</span>: (min_duties[<span style="color: #0000DD; font-weight: bold">1</span>]<span style="color: #333333">+</span><span style="color: #6600EE; font-weight: bold">5.6</span>)<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>         <span style="color: #888888"># (5.5+5.6)*200 = 2220µs</span>
      },
      <span style="background-color: #fff0f0">&#39;elbow&#39;</span>: {
          <span style="background-color: #fff0f0">&#39;pin&#39;</span>: <span style="color: #0000DD; font-weight: bold">26</span>,
          <span style="background-color: #fff0f0">&#39;min_pw&#39;</span>: min_duties[<span style="color: #0000DD; font-weight: bold">2</span>]<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>,              <span style="color: #888888"># 4 * 200 = 800µs</span>
          <span style="background-color: #fff0f0">&#39;max_pw&#39;</span>: (min_duties[<span style="color: #0000DD; font-weight: bold">2</span>]<span style="color: #333333">+</span><span style="color: #6600EE; font-weight: bold">3.4</span>)<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>         <span style="color: #888888"># (4+3.4)*200 = 1480µs</span>
      },
      <span style="background-color: #fff0f0">&#39;wrist&#39;</span>: {
          <span style="background-color: #fff0f0">&#39;pin&#39;</span>: <span style="color: #0000DD; font-weight: bold">4</span>,
          <span style="background-color: #fff0f0">&#39;min_pw&#39;</span>: min_duties[<span style="color: #0000DD; font-weight: bold">3</span>]<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>,              <span style="color: #888888"># 4.5 * 200 = 900µs</span>
          <span style="background-color: #fff0f0">&#39;max_pw&#39;</span>: (min_duties[<span style="color: #0000DD; font-weight: bold">3</span>]<span style="color: #333333">+</span><span style="color: #6600EE; font-weight: bold">1.7</span>)<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>         <span style="color: #888888"># (4.5+1.7)*200 = 1240µs</span>
      }
  }
  <span style="color: #888888"># Initialize all servo pins and set them to their default position (pulse width = 0)</span>
  <span style="color: #008800; font-weight: bold">for</span> joint, specs <span style="color: #000000; font-weight: bold">in</span> servo_specs<span style="color: #333333">.</span>items():
      pi<span style="color: #333333">.</span>set_mode(specs[<span style="background-color: #fff0f0">&#39;pin&#39;</span>], pigpio<span style="color: #333333">.</span>OUTPUT) <span style="color: #888888"># Set pin mode to OUTPUT</span>
      pi<span style="color: #333333">.</span>set_servo_pulsewidth(specs[<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)
      
  <span style="color: #888888"># Function to generate a range of float values with a specified step</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">frange</span>(start, stop, step):
      r <span style="color: #333333">=</span> start
      <span style="color: #008800; font-weight: bold">if</span> step <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">0</span>:
          <span style="color: #008800; font-weight: bold">while</span> r <span style="color: #333333">&lt;</span> stop:
              <span style="color: #008800; font-weight: bold">yield</span> r
              r <span style="color: #333333">+=</span> step
      <span style="color: #008800; font-weight: bold">else</span>:
          <span style="color: #008800; font-weight: bold">while</span> r <span style="color: #333333">&gt;</span> stop:
              <span style="color: #008800; font-weight: bold">yield</span> r
              r <span style="color: #333333">+=</span> step
              
  <span style="color: #888888"># Function to move a servo motor to a target pulse width</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">move_servo_slowly</span>(pin, start_pw, end_pw, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">25</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.1</span>):
      <span style="color: #888888"># Determine the movement based on start and end pulse width</span>
      <span style="color: #008800; font-weight: bold">if</span> start_pw <span style="color: #333333">&lt;</span> end_pw:
          pw_range <span style="color: #333333">=</span> frange(start_pw, end_pw, step)
      <span style="color: #008800; font-weight: bold">else</span>:
          pw_range <span style="color: #333333">=</span> frange(start_pw, end_pw, <span style="color: #333333">-</span>step)
      <span style="color: #888888"># Gradually adjust the pulse width and delay to allow smooth movement</span>
      <span style="color: #008800; font-weight: bold">for</span> pw <span style="color: #000000; font-weight: bold">in</span> pw_range:
          pi<span style="color: #333333">.</span>set_servo_pulsewidth(pin, pw)
          time<span style="color: #333333">.</span>sleep(delay)
      pi<span style="color: #333333">.</span>set_servo_pulsewidth(pin, end_pw)
      
  <span style="color: #888888"># Function to move servos to their default (home) positions</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">default</span>():
      <span style="color: #888888"># set default points for each servo</span>
      sh_mid <span style="color: #333333">=</span> ((servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">-</span> (<span style="color: #6600EE; font-weight: bold">0.5</span><span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>)
      ba_mid <span style="color: #333333">=</span> ((servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>)
      el_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>])  
      <span style="color: #888888"># Move each servo to its default position</span>
      pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], sh_mid)
      time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
      pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)
  
      pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], ba_mid)
      time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
      pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)
  
      pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], el_mid)
      time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
      pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)
      
  <span style="color: #888888"># Function to perform a &quot;pick&quot; action using the robotic arm</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">pick</span>(x, y):
      <span style="color: #888888"># Calculate initial midpoints for each joint</span>
      wr_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
      ba_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
      sh_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
      el_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
      <span style="color: #888888"># Move wrist servo to target position</span>
      wr_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>]
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], wr_mid, wr_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
      wr_mid <span style="color: #333333">=</span> wr_target
      <span style="color: #888888"># Move base servo to calculated target position based on `x(find_color_cube)` input</span>
      ba_target <span style="color: #333333">=</span> ba_mid <span style="color: #333333">+</span> (<span style="color: #007020">float</span>(<span style="color: #007020">int</span>((<span style="color: #0000DD; font-weight: bold">315</span> <span style="color: #333333">-</span> x) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">25</span>)) <span style="color: #333333">*</span> <span style="color: #6600EE; font-weight: bold">0.18</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">200</span>)
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], ba_mid, ba_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
      ba_mid <span style="color: #333333">=</span> ba_target
      <span style="color: #888888"># Move elbow servo to its minimum position</span>
      el_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], el_mid, el_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
      el_mid <span style="color: #333333">=</span> el_target
      <span style="color: #888888"># Move shoulder servo to its caculated target</span>
      sh_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> (<span style="color: #6600EE; font-weight: bold">0.2</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">200</span>) <span style="color: #888888"># 0.2 duty ~ 40µs step</span>
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], sh_mid, sh_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">20</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.02</span>)
      sh_mid <span style="color: #333333">=</span> sh_target
      <span style="color: #888888"># Move elbow servo to its caculated target</span>
      el_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>] <span style="color: #333333">+</span> <span style="color: #007020">float</span>(<span style="color: #007020">int</span>((y <span style="color: #333333">-</span> <span style="color: #0000DD; font-weight: bold">350</span>) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">25</span>)) <span style="color: #333333">*</span> (<span style="color: #6600EE; font-weight: bold">0.2</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">200</span>)
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], el_mid, el_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
      el_mid <span style="color: #333333">=</span> el_target
      <span style="color: #888888"># Move wrist servo to its caculated target</span>
      wr_target <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], wr_mid, wr_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
      wr_mid <span style="color: #333333">=</span> wr_target
      <span style="color: #888888"># Move shoulder servo to its caculated target</span>
      sh_target <span style="color: #333333">=</span> ((servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>) <span style="color: #333333">-</span> (<span style="color: #6600EE; font-weight: bold">0.5</span><span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>)
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], sh_mid, sh_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">20</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.02</span>)
      sh_mid <span style="color: #333333">=</span> sh_target
      <span style="color: #888888"># Move elbow servo to its caculated target</span>
      el_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> (<span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>)
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;elbow&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], el_mid, el_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
      el_mid <span style="color: #333333">=</span> el_target
      <span style="color: #888888"># Move base servo to its caculated target</span>
      ba_target <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], ba_mid, ba_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
      ba_mid <span style="color: #333333">=</span> ba_target
      
  <span style="color: #888888"># Function to perform returning item to a specified position)</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">release</span>(x, y):
      ba_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
      sh_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
  
      ba_target <span style="color: #333333">=</span> ba_mid <span style="color: #333333">+</span> <span style="color: #007020">float</span>(<span style="color: #007020">int</span>((<span style="color: #0000DD; font-weight: bold">300</span> <span style="color: #333333">-</span> x) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">25</span>)) <span style="color: #333333">*</span> (<span style="color: #6600EE; font-weight: bold">0.2</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">200</span>)
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;base&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], ba_mid, ba_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
      ba_mid <span style="color: #333333">=</span> ba_target
  
      sh_target <span style="color: #333333">=</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], sh_mid, sh_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
      sh_mid <span style="color: #333333">=</span> sh_target
  
      pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> (<span style="color: #6600EE; font-weight: bold">0.2</span><span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>))
      time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">1</span>)
      pi<span style="color: #333333">.</span>set_servo_pulsewidth(servo_specs[<span style="background-color: #fff0f0">&#39;wrist&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)
  <span style="color: #888888"># Function to move servos to their default (home) positions when returing the object</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">go_back_default</span>():
      <span style="color: #888888"># Calculate the midpoint of the pulse width range for the shoulder servo</span>
      sh_mid <span style="color: #333333">=</span> (servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;max_pw&#39;</span>] <span style="color: #333333">+</span> servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;min_pw&#39;</span>]) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">2</span>
      sh_target <span style="color: #333333">=</span> sh_mid <span style="color: #333333">-</span> (<span style="color: #6600EE; font-weight: bold">0.5</span><span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">200</span>)
      <span style="color: #888888"># Gradually move the shoulder servo to the calculated target position</span>
      move_servo_slowly(servo_specs[<span style="background-color: #fff0f0">&#39;shoulder&#39;</span>][<span style="background-color: #fff0f0">&#39;pin&#39;</span>], sh_mid, sh_target, step<span style="color: #333333">=</span><span style="color: #0000DD; font-weight: bold">10</span>, delay<span style="color: #333333">=</span><span style="color: #6600EE; font-weight: bold">0.05</span>)
        
  <span style="color: #888888"># Function to safely turn off all servo signals and clean up</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">ac_quit</span>():
      <span style="color: #008800; font-weight: bold">for</span> joint, specs <span style="color: #000000; font-weight: bold">in</span> servo_specs<span style="color: #333333">.</span>items():
          pi<span style="color: #333333">.</span>set_servo_pulsewidth(specs[<span style="background-color: #fff0f0">&#39;pin&#39;</span>], <span style="color: #0000DD; font-weight: bold">0</span>)
      pi<span style="color: #333333">.</span>stop()  <span style="color: #888888"># Stop pigpio daemon</span>
                </code></pre>
                <pre><code>

//motor_control.py
<span style="color: #888888"># Authors:  Chenxin Xun (cx258)</span>
<span style="color: #888888">#           Pengru Lung (pl649)</span>
<span style="color: #888888"># Final project, Monday Section</span>
<span style="color: #888888"># 2024-12-13</span>

<span style="color: #008800; font-weight: bold"># Import necessary libraries</span>
<span style="color: #008800; font-weight: bold">import</span> pygame, pigame  <span style="color: #888888"># pygame for GUI handling, pigame possibly a typo (should be pygame)</span>
<span style="color: #008800; font-weight: bold">from</span> pygame.locals <span style="color: #008800; font-weight: bold">import</span> *
<span style="color: #008800; font-weight: bold">import</span> os
<span style="color: #008800; font-weight: bold">import</span> RPi._GPIO <span style="color: #008800; font-weight: bold">as</span> GPIO  <span style="color: #888888"># GPIO library for Raspberry Pi</span>
<span style="color: #008800; font-weight: bold">import</span> sys
<span style="color: #008800; font-weight: bold">from</span> time <span style="color: #008800; font-weight: bold">import</span> sleep
<span style="color: #008800; font-weight: bold">import</span> time
<span style="color: #008800; font-weight: bold">import</span> threading  <span style="color: #888888"># For multithreading support</span>
<span style="color: #008800; font-weight: bold">import</span> color_detect <span style="color: #008800; font-weight: bold">as</span> cd  <span style="color: #888888"># Custom module for color detection</span>
<span style="color: #008800; font-weight: bold">import</span> math
<span style="color: #008800; font-weight: bold">import</span> arm_control <span style="color: #008800; font-weight: bold">as</span> ac  <span style="color: #888888"># Custom module for robotic arm control</span>
<span style="color: #008800; font-weight: bold">import</span> cv2  <span style="color: #888888"># OpenCV for computer vision tasks</span>
<span style="color: #008800; font-weight: bold">import</span> server_color <span style="color: #008800; font-weight: bold">as</span> sc  <span style="color: #888888"># Custom module for server-based color communication</span>

<span style="color: #008800; font-weight: bold"># GPIO pin setup for Raspberry Pi</span>
GPIO.setmode(GPIO.BCM)  <span style="color: #888888"># Use Broadcom GPIO numbering</span>
GPIO.setup(19, GPIO.OUT)  <span style="color: #888888"># Motor PWM pin</span>
GPIO.setup(5, GPIO.OUT)  <span style="color: #888888"># Left motor control pin</span>
GPIO.setup(6, GPIO.OUT)  <span style="color: #888888"># Left motor control pin</span>
GPIO.setup(16, GPIO.OUT)  <span style="color: #888888"># Motor PWM pin</span>
GPIO.setup(20, GPIO.OUT)  <span style="color: #888888"># Right motor control pin</span>
GPIO.setup(21, GPIO.OUT)  <span style="color: #888888"># Right motor control pin</span>

<span style="color: #008800; font-weight: bold"># Motor PWM configuration</span>
freq = <span style="color: #0000DD; font-weight: bold">480</span>  <span style="color: #888888"># Frequency in Hz</span>
duty_cycleA = <span style="color: #0000DD; font-weight: bold">0</span>  <span style="color: #888888"># Initial duty cycle for motor A</span>
duty_cycleB = <span style="color: #0000DD; font-weight: bold">0</span>  <span style="color: #888888"># Initial duty cycle for motor B</span>
pwm24 = GPIO.PWM(<span style="color: #0000DD; font-weight: bold">19</span>, freq)
pwm16 = GPIO.PWM(<span style="color: #0000DD; font-weight: bold">16</span>, freq)
pwm24.start(duty_cycleA)
pwm16.start(duty_cycleB)

<span style="color: #008800; font-weight: bold"># Initialize Pygame</span>
pygame.init()

<span style="color: #008800; font-weight: bold"># Global flags and variables</span>
flag = <span style="color: #0000DD; font-weight: bold">0</span>
pause = <span style="color: #000000; font-weight: bold">False</span>
category = ''  <span style="color: #888888"># Detected color category</span>
x = <span style="color: #0000DD; font-weight: bold">0</span>  <span style="color: #888888"># X-coordinate of detected object</span>
y = <span style="color: #0000DD; font-weight: bold">0</span>  <span style="color: #888888"># Y-coordinate of detected object</span>
approx = []  <span style="color: #888888"># Object contour approximation</span>
checking = <span style="color: #000000; font-weight: bold">True</span>
lock = threading.Lock()  <span style="color: #888888"># Thread synchronization lock</span>

<span style="color: #008800; font-weight: bold"># Left motor counterclockwise rotation</span>
<span style="color: #008800; font-weight: bold">def</span> lccw(speed):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> pause:
        GPIO.output(<span style="color: #0000DD; font-weight: bold">5</span>, GPIO.HIGH)
        GPIO.output(<span style="color: #0000DD; font-weight: bold">6</span>, GPIO.LOW)
        pwm24.ChangeDutyCycle(speed)

<span style="color: #008800; font-weight: bold"># Right motor clockwise rotation</span>
<span style="color: #008800; font-weight: bold">def</span> rcw(speed):
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> pause:
        GPIO.output(<span style="color: #0000DD; font-weight: bold">21</span>, GPIO.HIGH)
        GPIO.output(<span style="color: #0000DD; font-weight: bold">20</span>, GPIO.LOW)
        pwm16.ChangeDutyCycle(speed)

<span style="color: #008800; font-weight: bold"># Stop left motor</span>
<span style="color: #008800; font-weight: bold">def</span> lstop():
    pwm24.ChangeDutyCycle(<span style="color: #0000DD; font-weight: bold">0</span>)

<span style="color: #008800; font-weight: bold"># Stop right motor</span>
<span style="color: #008800; font-weight: bold">def</span> rstop():
    pwm16.ChangeDutyCycle(<span style="color: #0000DD; font-weight: bold">0</span>)

<span style="color: #008800; font-weight: bold"># Main motor control loop</span>
<span style="color: #008800; font-weight: bold">def</span> run_motor():
    <span style="color: #008800; font-weight: bold">global</span> category, x, y, approx
    desired_center = <span style="color: #0000DD; font-weight: bold">320</span>  <span style="color: #888888"># Desired center X-coordinate</span>
    proportional_gain = <span style="color: #6600EE; font-weight: bold">0.6</span>  <span style="color: #888888"># Proportional gain for PID control</span>
    dead_zone = <span style="color: #0000DD; font-weight: bold">10</span>  <span style="color: #888888"># Dead zone to prevent jittering</span>
    prev_left_speed = <span style="color: #0000DD; font-weight: bold">0</span>
    prev_right_speed = <span style="color: #0000DD; font-weight: bold">0</span>
    max_delta = <span style="color: #0000DD; font-weight: bold">5</span>  <span style="color: #888888"># Max change in speed to smooth transitions</span>
    time.sleep(<span style="color: #0000DD; font-weight: bold">2</span>)

    <span style="color: #008800; font-weight: bold"># Initial motor movement</span>
    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #000000; font-weight: bold">True</span>:
        lccw(<span style="color: #0000DD; font-weight: bold">100</span>)
        time.sleep(<span style="color: #6600EE; font-weight: bold">0.15</span>)
        <span style="color: #008800; font-weight: bold">with</span> lock:
            category = cd.color_name
            x = cd.cx
            y = cd.cy
            approx = cd.approx

        <span style="color: #008800; font-weight: bold">if</span> category == cd.target:
            <span style="color: #008800; font-weight: bold">break</span>
        lstop()
        time.sleep(<span style="color: #6600EE; font-weight: bold">0.2</span>)

    <span style="color: #008800; font-weight: bold"># Object tracking logic</span>
    <span style="color: #008800; font-weight: bold">while</span> <span style="color: #000000; font-weight: bold">True</span>:
        <span style="color: #008800; font-weight: bold">with</span> lock:
            <span style="color: #008800; font-weight: bold">if</span> cd.stop:
                lstop()
                rstop()
                <span style="color: #008800; font-weight: bold">break</span>
            category = cd.color_name
            x = cd.cx
            y = cd.cy
            approx = cd.approx
            step_stop = cd.step_stop

        <span style="color: #008800; font-weight: bold">if</span> category == cd.target:
            checking = <span style="color: #000000; font-weight: bold">False</span>
            object_center = x
            error = object_center - desired_center
            <span style="color: #008800; font-weight: bold">if</span> abs(error) < dead_zone:
                lstop()
                rstop()
                <span style="color: #008800; font-weight: bold">continue</span>

            correction = proportional_gain * error / desired_center * <span style="color: #0000DD; font-weight: bold">50</span>
            base_speed = <span style="color: #0000DD; font-weight: bold">80</span>  <span style="color: #888888"># Base speed for motors</span>
            left_speed = base_speed + correction
            right_speed = base_speed - correction
            left_speed = <span style="color: #008800; font-weight: bold">max</span>(<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #008800; font-weight: bold">min</span>(<span style="color: #0000DD; font-weight: bold">100</span>, left_speed))
            right_speed = <span style="color: #008800; font-weight: bold">max</span>(<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #008800; font-weight: bold">min</span>(<span style="color: #0000DD; font-weight: bold">100</span>, right_speed))
            left_speed = <span style="color: #008800; font-weight: bold">max</span>(prev_left_speed - max_delta, <span style="color: #008800; font-weight: bold">min</span>(left_speed, prev_left_speed + max_delta))
            right_speed = <span style="color: #008800; font-weight: bold">max</span>(prev_right_speed - max_delta, <span style="color: #008800; font-weight: bold">min</span>(right_speed, prev_right_speed + max_delta))
            prev_left_speed = left_speed
            prev_right_speed = right_speed
            lccw(left_speed)
            rcw(right_speed)
            time.sleep(<span style="color: #6600EE; font-weight: bold">0.05</span>)
        <span style="color: #008800; font-weight: bold">else</span>:
            lstop()
            rstop()
            time.sleep(<span style="color: #6600EE; font-weight: bold">0.1</span>)

<span style="color: #008800; font-weight: bold"># Main execution logic with threading for motor and detection tasks</span>
<span style="color: #008800; font-weight: bold">try</span>:
    sc.sending_color()  <span style="color: #888888"># Fetch target color from the server</span>
    cd.target = sc.data
    <span style="color: #008800; font-weight: bold">if</span> cd.target == <span style="background-color: #fff0f0">"Green"</span>:
        cd.target_pos = <span style="color: #0000DD; font-weight: bold">339</span>  <span style="color: #888888"># Calibrate positions</span>
    <span style="color: #008800; font-weight: bold">if</span> cd.target == <span style="background-color: #fff0f0">"Yellow"</span>:
        cd.target_pos = <span style="color: #0000DD; font-weight: bold">315</span>  <span style="color: #888888"># Calibrate positions</span>
    <span style="color: #008800; font-weight: bold">if</span> cd.target == <span style="background-color: #fff0f0">"Blue"</span>:
        cd.target_pos = <span style="color: #0000DD; font-weight: bold">329</span>  <span style="color: #888888"># Calibrate positions</span>

    ac.default()  <span style="color: #888888"># Reset robotic arm to default position</span>
    motor_thread = threading.Thread(target=run_motor)
    detect_thread = threading.Thread(target=cd.color_detection)

    motor_thread.start()
    detect_thread.start()

    motor_thread.join()
    detect_thread.join()

    pwm24.stop()
    pwm16.stop()
    ac.default()

    <span style="color: #888888"># Capture video and find the target object</span>
    cap = cv2.VideoCapture(<span style="color: #0000DD; font-weight: bold">0</span>)
    color_name = ''
    <span style="color: #008800; font-weight: bold">while</span> color_name != cd.target:
        ret, frame = cap.read()
        color_name, x, y, approx = cd.find_color_cubes(frame)
    cd.cd_stop()
    ac.pick(x, y)

    ac.ac_quit()
    sys.exit()

<span style="color: #008800; font-weight: bold">except</span> KeyboardInterrupt:
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">"Keyboard interrupt received. Cleaning up..."</span>)
<span style="color: #008800; font-weight: bold">finally</span>:
    cd.cd_stop()  <span style="color: #888888"># Stop color detection</span>

  </code></pre>
  <pre><code>

//go_back.py
  <span style="color: #888888"># Authors:  Chenxin Xun (cx258)</span>
  <span style="color: #888888">#           Pengru Lung (pl649)</span>
  <span style="color: #888888"># Final project, Monday Section</span>
  <span style="color: #888888"># 2024-12-13</span>
  
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">pygame, pigame</span>  <span style="color: #888888"># pygame for GUI handling, pigame could be a typo or placeholder</span>
  <span style="color: #008800; font-weight: bold">from</span> <span style="color: #333333">pygame.locals</span> <span style="color: #008800; font-weight: bold">import</span> *
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">os</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">RPi._GPIO as GPIO</span>  <span style="color: #888888"># GPIO library for Raspberry Pi for pin control</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">sys</span>
  <span style="color: #008800; font-weight: bold">from</span> <span style="color: #333333">time</span> <span style="color: #008800; font-weight: bold">import</span> sleep
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">time</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">threading</span>  <span style="color: #888888"># For multithreading</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">color_detect as cd</span>  <span style="color: #888888"># Custom module for color detection</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">math</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">arm_control as ac</span>  <span style="color: #888888"># Custom module for robotic arm control</span>
  <span style="color: #008800; font-weight: bold">import</span> <span style="color: #333333">cv2</span>  <span style="color: #888888"># OpenCV for computer vision</span>
  
  <span style="color: #888888"># GPIO pin configuration for Raspberry Pi</span>
  GPIO.<span style="color: #333333">setmode(GPIO.BCM)</span>  <span style="color: #888888"># Use Broadcom GPIO numbering</span>
  GPIO.<span style="color: #333333">setup(19, GPIO.OUT)</span>  <span style="color: #888888"># PWM pin for left motor</span>
  GPIO.<span style="color: #333333">setup(5, GPIO.OUT)</span>   <span style="color: #888888"># Left motor control pin</span>
  GPIO.<span style="color: #333333">setup(6, GPIO.OUT)</span>   <span style="color: #888888"># Left motor control pin</span>
  GPIO.<span style="color: #333333">setup(16, GPIO.OUT)</span>  <span style="color: #888888"># PWM pin for right motor</span>
  GPIO.<span style="color: #333333">setup(20, GPIO.OUT)</span>  <span style="color: #888888"># Right motor control pin</span>
  GPIO.<span style="color: #333333">setup(21, GPIO.OUT)</span>  <span style="color: #888888"># Right motor control pin</span>
  
  <span style="color: #888888"># Motor PWM setup</span>
  <span style="color: #333333">freq = 480</span>  <span style="color: #888888"># PWM frequency in Hz</span>
  <span style="color: #333333">duty_cycleA = 0</span>  <span style="color: #888888"># Initial duty cycle for motor A</span>
  <span style="color: #333333">duty_cycleB = 0</span>  <span style="color: #888888"># Initial duty cycle for motor B</span>
  <span style="color: #333333">pwm24 = GPIO.PWM(19, freq)</span>
  <span style="color: #333333">pwm16 = GPIO.PWM(16, freq)</span>
  <span style="color: #333333">pwm24.start(duty_cycleA)</span>
  <span style="color: #333333">pwm16.start(duty_cycleB)</span>
  
  <span style="color: #888888"># Initialize Pygame for GUI or event handling</span>
  pygame.<span style="color: #333333">init()</span>
  
  <span style="color: #888888"># Global flags and variables</span>
  <span style="color: #333333">flag = 0</span>
  <span style="color: #333333">pause = False</span>
  <span style="color: #333333">category = ''</span>  <span style="color: #888888"># Detected object category</span>
  <span style="color: #333333">x = 0</span>  <span style="color: #888888"># X-coordinate of detected object</span>
  <span style="color: #333333">y = 0</span>  <span style="color: #888888"># Y-coordinate of detected object</span>
  <span style="color: #333333">approx = []</span>  <span style="color: #888888"># Contour approximation of the object</span>
  <span style="color: #333333">checking = True</span>
  <span style="color: #333333">lock = threading.Lock()</span>  <span style="color: #888888"># Lock for thread-safe access to shared variables</span>
  
  <span style="color: #888888"># Control left motor counterclockwise</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #333333">lccw(speed):</span>
      <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">not pause:</span>
          GPIO.<span style="color: #333333">output(5, GPIO.HIGH)</span>
          GPIO.<span style="color: #333333">output(6, GPIO.LOW)</span>
          pwm24.<span style="color: #333333">ChangeDutyCycle(speed)</span>
  
  <span style="color: #888888"># Control right motor clockwise</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #333333">rcw(speed):</span>
      <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">not pause:</span>
          GPIO.<span style="color: #333333">output(21, GPIO.HIGH)</span>
          GPIO.<span style="color: #333333">output(20, GPIO.LOW)</span>
          pwm16.<span style="color: #333333">ChangeDutyCycle(speed)</span>
  
  <span style="color: #888888"># Stop left motor</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #333333">lstop():</span>
      pwm24.<span style="color: #333333">ChangeDutyCycle(0)</span>
  
  <span style="color: #888888"># Stop right motor</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #333333">rstop():</span>
      pwm16.<span style="color: #333333">ChangeDutyCycle(0)</span>
  
  <span style="color: #888888"># Main motor control function</span>
  <span style="color: #008800; font-weight: bold">def</span> <span style="color: #333333">run_motor():</span>
      <span style="color: #008800; font-weight: bold">global</span> <span style="color: #333333">category, x, y, approx</span>
      <span style="color: #333333">desired_center = 320</span>  <span style="color: #888888"># Desired X-coordinate of the object center</span>
      <span style="color: #333333">proportional_gain = 0.6</span>  <span style="color: #888888"># Proportional gain for PID control</span>
      <span style="color: #333333">dead_zone = 10</span>  <span style="color: #888888"># Error threshold to avoid small corrections</span>
      <span style="color: #333333">prev_left_speed = 0</span>  <span style="color: #888888"># Previous left motor speed</span>
      <span style="color: #333333">prev_right_speed = 0</span> <span style="color: #888888"># Previous right motor speed</span>
      <span style="color: #333333">max_delta = 5</span>  <span style="color: #888888"># Maximum change in speed to smooth transitions</span>
  
      time.<span style="color: #333333">sleep(2)</span>  <span style="color: #888888"># Initial delay for system setup</span>
  
      <span style="color: #888888"># Loop for initial detection and alignment</span>
      <span style="color: #008800; font-weight: bold">while</span> <span style="color: #333333">True:</span>
          <span style="color: #008800; font-weight: bold">with</span> <span style="color: #333333">lock:</span>
              category = cd.<span style="color: #333333">color_name</span>
              x = cd.<span style="color: #333333">cx</span>
              y = cd.<span style="color: #333333">cy</span>
              approx = cd.<span style="color: #333333">approx</span>
  
          <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">category == cd.target:</span>
              <span style="color: #008800; font-weight: bold">break</span>
  
          lccw(<span style="color: #333333">100</span>)  <span style="color: #888888"># Move left motor counterclockwise</span>
          time.<span style="color: #333333">sleep(0.15)</span>  <span style="color: #888888"># Brief movement duration</span>
          lstop()  <span style="color: #888888"># Stop left motor</span>
          time.<span style="color: #333333">sleep(0.2)</span>  <span style="color: #888888"># Short pause</span>
  
      <span style="color: #888888"># Loop for precise object tracking</span>
      <span style="color: #008800; font-weight: bold">while</span> <span style="color: #333333">True:</span>
          <span style="color: #008800; font-weight: bold">with</span> <span style="color: #333333">lock:</span>
              <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">cd.stop:</span>
                  lstop()
                  rstop()
                  <span style="color: #008800; font-weight: bold">break</span>
              category = cd.<span style="color: #333333">color_name</span>
              x = cd.<span style="color: #333333">cx</span>
              y = cd.<span style="color: #333333">cy</span>
              approx = cd.<span style="color: #333333">approx</span>
  
          <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">category == cd.target:</span>
              checking = <span style="color: #333333">False</span>
              object_center = x
              error = object_center - desired_center
  
              <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">abs(error) &lt; dead_zone:</span>  <span style="color: #888888"># Check if within acceptable range</span>
                  lstop()
                  rstop()
                  <span style="color: #008800; font-weight: bold">continue</span>
  
              correction = proportional_gain * error / desired_center * <span style="color: #333333">50</span>
              base_speed = <span style="color: #333333">80</span>  <span style="color: #888888"># Base speed for motors</span>
              left_speed = base_speed + correction
              right_speed = base_speed - correction
  
              <span style="color: #888888"># Clamp speeds and smooth transitions</span>
              <span style="color: #333333">left_speed = max(0, min(100, left_speed))</span>
              <span style="color: #333333">right_speed = max(0, min(100, right_speed))</span>
              <span style="color: #333333">left_speed = max(prev_left_speed - max_delta, min(left_speed, prev_left_speed + max_delta))</span>
              <span style="color: #333333">right_speed = max(prev_right_speed - max_delta, min(right_speed, prev_right_speed + max_delta))</span>
              <span style="color: #333333">prev_left_speed = left_speed</span>
              <span style="color: #333333">prev_right_speed = right_speed</span>
  
              lccw(left_speed)  <span style="color: #888888"># Adjust left motor speed</span>
              rcw(right_speed)  <span style="color: #888888"># Adjust right motor speed</span>
              time.<span style="color: #333333">sleep(0.05)</span>  <span style="color: #888888"># Brief control interval</span>
          <span style="color: #008800; font-weight: bold">else</span>:
              lstop()
              rstop()
              time.<span style="color: #333333">sleep(0.1)</span>  <span style="color: #888888"># Pause when target not detected</span>
  
  <span style="color: #888888"># Main program logic</span>
  <span style="color: #008800; font-weight: bold">try</span>:
      cd.<span style="color: #333333">enable_threshold_filter = True</span>  <span style="color: #888888"># Enable threshold-based filtering</span>
      cd.<span style="color: #333333">target = "Blue"</span>  <span style="color: #888888"># Set target color</span>
      cd.<span style="color: #333333">target_pos = 320</span>  <span style="color: #888888"># Set target position</span>
      ac.<span style="color: #333333">go_back_default()</span>  <span style="color: #888888"># Reset robotic arm to default position</span>
  
      <span style="color: #888888"># Create threads for motor control and color detection</span>
      motor_thread = threading.<span style="color: #333333">Thread(target=run_motor)</span>
      detect_thread = threading.<span style="color: #333333">Thread(target=cd.color_detection)</span>
  
      motor_thread.<span style="color: #333333">start()</span>
      detect_thread.<span style="color: #333333">start()</span>
  
      motor_thread.<span style="color: #333333">join()</span>  <span style="color: #888888"># Wait for motor thread to complete</span>
      detect_thread.<span style="color: #333333">join()</span>  <span style="color: #888888"># Wait for detection thread to complete</span>
  
      pwm24.<span style="color: #333333">stop()</span>
      pwm16.<span style="color: #333333">stop()</span>
  
      ac.<span style="color: #333333">default()</span>  <span style="color: #888888"># Reset robotic arm to default state</span>
      cap = cv2.<span style="color: #333333">VideoCapture(0)</span>  <span style="color: #888888"># Open video capture</span>
      color_name = <span style="color: #333333">''</span>
      <span style="color: #008800; font-weight: bold">while</span> <span style="color: #333333">color_name != cd.target:</span>
          ret, frame = cap.<span style="color: #333333">read()</span>
          color_name, x, y, approx = cd.<span style="color: #333333">find_color_cubes(frame)</span>
      cd.<span style="color: #333333">cd_stop()</span>
  
      ac.<span style="color: #333333">release(x, y)</span>  <span style="color: #888888"># Release the object at detected position</span>
  
      ac.<span style="color: #333333">ac_quit()</span>
      sys.<span style="color: #333333">exit()</span>  <span style="color: #888888"># Exit the program</span>
      cd.<span style="color: #333333">cd_stop()</span>
  
  <span style="color: #008800; font-weight: bold">except</span> KeyboardInterrupt:
      <span style="color: #333333">print("Keyboard interrupt received. Cleaning up...")</span>
  <span style="color: #008800; font-weight: bold">finally</span>:
      cd.<span style="color: #333333">cd_stop()</span>  <span style="color: #888888"># Ensure color detection stops on exit</span>
    </code></pre>
    <pre><code>
// run.sh
<span style="color: #888888"># Authors:  Chenxin Xun (cx258)</span>
<span style="color: #888888">#           Pengru Lung (pl649)</span>
<span style="color: #888888"># Final project, Monday Section</span>
<span style="color: #888888"># 2024-12-13</span>
<span style="color: #888888">#!/usr/bin/env bash</span>
<span style="color: #888888"># Start the pigpio daemon, which is required for GPIO control</span>
sudo pigpiod
<span style="color: #888888"># Infinite loop to continuously execute the Python scripts</span>
<span style="color: #008800; font-weight: bold">while</span> true
do
    <span style="color: #888888"># Run the motor control script</span>
    sudo python3 motor_control<span style="color: #333333">.</span>py
    <span style="color: #888888"># Run the go-back script</span>
    sudo python3 go_back<span style="color: #333333">.</span>py
    <span style="color: #888888"># Optionally, Pause for 1 second before the next iteration</span>
done
                                </code></pre>    
                

      </div>

    </div><!-- /.container -->




    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!-- <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script> -->
  </body>
</html>
